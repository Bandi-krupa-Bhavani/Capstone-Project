<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Readable PDF with Clean Text + Audio + Search</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<style>
  body { margin:0; display:flex; height:100vh; font-family:Arial, sans-serif; }
  #sidebar {
    width:300px; border-right:1px solid #ccc; padding:12px;
    display:flex; flex-direction:column; background:#fff;
  }
  #pdf-container { flex:1; overflow-y:auto; background:#f7f7f7; text-align:center; }
  canvas { margin:15px auto; display:block; box-shadow:0 0 6px rgba(0,0,0,0.1); }
  #text-panel {
    flex:1; overflow-y:auto; background:#f9f9f9; padding:8px; margin-top:10px;
    border:1px solid #ddd; border-radius:6px; white-space:pre-wrap; text-align:left;
  }
  button { background:#4b7bec; color:#fff; border:none; border-radius:5px; padding:6px 10px; margin:3px; cursor:pointer; }
  button:hover{background:#3867d6;}
  input,select{padding:6px; border:1px solid #ccc; border-radius:4px;}
</style>
</head>
<body>

<div id="sidebar">
  <input type="file" id="pdf-upload" accept="application/pdf"><br>
  <div>
    <label>Search:</label><br>
    <input type="text" id="searchBox" placeholder="Search text...">
    <div id="searchCount"></div>
  </div>
  <div style="margin-top:10px;">
    <button id="back10">⏪10s</button>
    <button id="play">▶</button>
    <button id="pause">⏸</button>
    <button id="fwd10">⏩10s</button><br>
    Speed:
    <select id="speed">
      <option>0.75</option><option selected>1</option><option>1.25</option>
      <option>1.5</option><option>2</option>
    </select>x
  </div>
  <div id="pageInfo" style="margin-top:10px;"></div>
  <div id="text-panel">Upload a PDF to view text here…</div>
</div>

<div id="pdf-container"></div>

<script>
let pdfDoc=null,currentPage=1,totalPages=0,utterance,textCache=[];
const viewer=document.getElementById('pdf-container');
const textPanel=document.getElementById('text-panel');

document.getElementById('pdf-upload').addEventListener('change',async e=>{
  const f=e.target.files[0]; if(!f)return;
  const arr=new Uint8Array(await f.arrayBuffer());
  pdfDoc=await pdfjsLib.getDocument(arr).promise;
  totalPages=pdfDoc.numPages;
  document.getElementById('pageInfo').textContent=`Page 1 / ${totalPages}`;
  await renderAll();
  showText(1);
});

async function renderAll(){
  viewer.innerHTML='';
  textCache=[];
  for(let i=1;i<=totalPages;i++){
    const page=await pdfDoc.getPage(i);
    const vp=page.getViewport({scale:1.2});
    const c=document.createElement('canvas');
    const ctx=c.getContext('2d');
    c.width=vp.width; c.height=vp.height;
    await page.render({canvasContext:ctx,viewport:vp}).promise;
    c.dataset.page=i;
    c.onclick=()=>showText(i);
    viewer.appendChild(c);

    const text=await page.getTextContent();
    const clean=text.items.map(it=>it.str).join(' ');
    textCache.push(clean);
  }
}

function showText(p){
  currentPage=p;
  textPanel.textContent=textCache[p-1];
  document.getElementById('pageInfo').textContent=`Page ${p} / ${totalPages}`;
  viewer.querySelector(`[data-page="${p}"]`).scrollIntoView({behavior:'smooth'});
}

// ----- Search -----
document.getElementById('searchBox').addEventListener('input',()=>{
  const q=document.getElementById('searchBox').value.toLowerCase();
  if(!q){textPanel.innerHTML=textCache[currentPage-1];return;}
  const text=textCache[currentPage-1];
  const matches=(text.match(new RegExp(q,'gi'))||[]).length;
  document.getElementById('searchCount').textContent=
      matches?`${matches} found on this page`:'No match';
  const html=text.replace(new RegExp(q,'gi'),m=>`<mark>${m}</mark>`);
  textPanel.innerHTML=html;
});

// ----- Audio -----
document.getElementById('play').onclick=()=>{
  const sel=window.getSelection().toString().trim()||
             textPanel.innerText.trim();
  if(!sel)return alert('Select or view some text.');
  speak(sel);
};
document.getElementById('pause').onclick=()=>speechSynthesis.pause();
document.getElementById('back10').onclick=()=>jump(-10);
document.getElementById('fwd10').onclick=()=>jump(10);

function speak(t){
  speechSynthesis.cancel();
  utterance=new SpeechSynthesisUtterance(t);
  utterance.rate=parseFloat(document.getElementById('speed').value);
  speechSynthesis.speak(utterance);
}
function jump(sec){
  if(!utterance)return;
  speechSynthesis.cancel();
  const words=textPanel.innerText.split(' ');
  const cut=Math.floor(words.length/5); // rough skip
  speak(sec>0?words.slice(cut).join(' '):words.slice(0).join(' '));
}
</script>
</body>
</html>
