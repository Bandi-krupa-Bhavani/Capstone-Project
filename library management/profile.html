<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="css/profile.css">
  <title>Profile Page</title>
</head>
<body>
  <header>
    <div class="logo">
      <i class="fas fa-book"></i> BookVerse
    </div>
  </header>

  <div class="sidebar" id="sidebar">
    <a href="dashboard.html"><i class="fa-solid fa-house"></i> Dashboard</a>
    <a href="profile.html"><i class="fa-solid fa-user"></i> Profile</a>
    <a href="library.html"><i class="fa-solid fa-book-open"></i> My Library</a>
    <a href="home.html"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
  </div>

  <button class="toggle-btn" id="toggleBtn">‚ò∞</button>

  <div class="content" id="mainContent">
    <div class="profile-photo-wrapper">
      <div id="profilePhotoContainer"><div class="avatar">U</div></div>
    </div>

    <h2 class="profile-name" id="profileName"></h2><br>
    <div class="actions">
      <a href="edit-profile.html"><button class="action-btn"><span>‚úèÔ∏è</span> Edit Profile</button></a>
      <a href="passw-sec.html"><button class="action-btn"><span>üîí</span> Password & Security</button></a>
      <a href="help-support.html"><button class="action-btn"><span>‚ùì</span> Help & Support</button></a>
      <button class="action-btn" id="logoutBtn"><span>üö™</span> Logout</button>
    </div>
  </div>

  <script type="module">
    import { auth, db } from "./firebase-config.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const profileName = document.getElementById("profileName");
    const profilePhotoContainer = document.getElementById("profilePhotoContainer");

    // Display first letter avatar
    function displayNameAvatar(fullname = "User") {
      profileName.textContent = fullname;
      const letter = fullname.charAt(0).toUpperCase();
      profilePhotoContainer.innerHTML = `<div class="avatar">${letter}</div>`;
    }

    // --- Show cached name immediately if recent ---
    const cachedName = sessionStorage.getItem("fullname");
    const cachedTime = parseInt(sessionStorage.getItem("fullnameUpdatedAt") || 0);
    const now = new Date().getTime();

    if (cachedName && (now - cachedTime < 5 * 60 * 1000)) { // 5 minutes threshold
      displayNameAvatar(cachedName);
    }

    // Auth listener
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        sessionStorage.clear();
        window.location.href = "login.html";
        return;
      }

      const editRef = doc(db, "editProfiles", user.uid);

      // Real-time listener for Firestore document
      onSnapshot(editRef, (docSnap) => {
        let fullname = "User";
        if (docSnap.exists() && docSnap.data().fullname?.trim()) {
          fullname = docSnap.data().fullname.trim();
        } else if (user.displayName) {
          fullname = user.displayName;
        }

        // Update cache with timestamp
        sessionStorage.setItem("fullname", fullname);
        sessionStorage.setItem("fullnameUpdatedAt", new Date().getTime());

        displayNameAvatar(fullname); // Updates name and avatar instantly
      });
    });

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await auth.signOut();
      sessionStorage.clear();
      window.location.href = "home.html";
    });

    // Sidebar toggle
    const toggleBtn = document.getElementById("toggleBtn");
    const sidebar = document.getElementById("sidebar");
    const mainContent = document.getElementById("mainContent");
    toggleBtn.addEventListener("click", () => {
      sidebar.classList.toggle("active");
      mainContent.classList.toggle("shift");
    });
  </script>
</body>
</html>
