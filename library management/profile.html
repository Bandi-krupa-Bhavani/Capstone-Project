<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<link rel="stylesheet" href="css/profile.css">
<title>Profile Page</title>
</head>
<body>
  <div class="sidebar" id="sidebar">
  <h3 style="color:#444">ğŸ“š BOOKVERSE</h3>
  <a href="dashboard.html"><i class="fa-solid fa-house"></i> Dashboard</a>
  <a href="profile.html"><i class="fa-solid fa-user"></i> Profile</a>
  <a href="library.html"><i class="fa-solid fa-book-open"></i> My Library</a>
  <a href="home.html"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
</div>

<button class="toggle-btn" id="toggleBtn">â˜°</button>

<div class="content" id="mainContent">
  <div class="profile-photo-wrapper" id="profileWrapper">
    <div id="profilePhotoContainer"><div class="avatar">U</div></div>
    <div class="camera-toggle" id="cameraToggle"><i class="fa-solid fa-camera"></i></div>
    <div class="photo-options" id="photoOptions">
      <button id="updatePhotoBtn">Update Photo</button>
      <button id="deletePhotoBtn">Delete Photo</button>
    </div>
  </div>

  <h2 class="profile-name" id="profileName"></h2><br>
  <div class="actions">
  <a href="edit-profile.html"><button class="action-btn"><span>âœï¸</span> Edit Profile</button></a>
  <a href="password-security.html"><button class="action-btn"><span>ğŸ”’</span> Password & Security</button></a>
  <a href="help-support.html"><button class="action-btn"><span>â“</span> Help & Support</button></a>
  <button class="action-btn" id="logoutBtn"><span>ğŸšª</span> Logout</button>
</div>
</div>

<script type="module">
import { auth, db, storage } from "./firebase-config.js";   // âœ… storage from config
import { onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

const profileName = document.getElementById("profileName");
const profilePhotoContainer = document.getElementById("profilePhotoContainer");
const photoOptions = document.getElementById("photoOptions");
const cameraToggle = document.getElementById("cameraToggle");
const profileWrapper = document.getElementById("profileWrapper");

// Append camera toggle & options
profileWrapper.appendChild(cameraToggle);
profileWrapper.appendChild(photoOptions);

// Toggle photo options
cameraToggle.addEventListener("click", () => {
  photoOptions.style.display = (photoOptions.style.display === "flex") ? "none" : "flex";
});

// Helper: display name & avatar
function displayNameAvatar(fullname, photoURL=null) {
  profileName.textContent = fullname;
  if(photoURL){
    profilePhotoContainer.innerHTML = `<img src="${photoURL}" class="profile-pic" alt="Profile Photo">`;
  } else {
    profilePhotoContainer.innerHTML = `<div class="avatar">${fullname.charAt(0).toUpperCase()}</div>`;
  }
}

// Check sessionStorage first
const storedName = sessionStorage.getItem("fullname");
const storedLetter = sessionStorage.getItem("firstLetter");
if(storedName && storedLetter){
  displayNameAvatar(storedName);
}

// Auth listener
onAuthStateChanged(auth, async (user) => {
  if(!user){
    sessionStorage.clear();
    window.location.href = "login.html";
    return;
  }

  try {
    const currentUID = user.uid;
    const storedUID = sessionStorage.getItem("uid");

    let fullname;

    // If stored UID matches current user, use cached name
    if(storedUID === currentUID){
      fullname = sessionStorage.getItem("fullname") || "User";
    } else {
      // Fetch from Firestore for new user
      const userDocRef = doc(db,"users",currentUID);
      const userDocSnap = await getDoc(userDocRef);
      fullname = userDocSnap.exists() && userDocSnap.data().fullname ? userDocSnap.data().fullname : "User";

      // Save to sessionStorage
      sessionStorage.setItem("uid", currentUID);
      sessionStorage.setItem("fullname", fullname);
      sessionStorage.setItem("firstLetter", fullname.charAt(0).toUpperCase());
    }

    displayNameAvatar(fullname, user.photoURL);

  } catch(err){
    console.error("Error fetching user data:", err);
    profileName.textContent = "Error loading name";
  }
});


// Upload photo
document.getElementById("updatePhotoBtn").addEventListener("click", async () => {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";

  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const storageRef = ref(storage, `profilePhotos/${auth.currentUser.uid}`);

    try {
      // Upload file
      await uploadBytes(storageRef, file);

      // Get URL
      const downloadURL = await getDownloadURL(storageRef);

      // Update Firebase Auth profile
      await updateProfile(auth.currentUser, { photoURL: downloadURL });

      // Update UI
      displayNameAvatar(sessionStorage.getItem("fullname"), downloadURL);

      alert("Profile photo updated âœ…");
    } catch (err) {
      console.error(err);
      alert("Failed to upload photo âŒ");
    }
  };

  input.click();
});


// Delete photo
document.getElementById("deletePhotoBtn").addEventListener("click", async () => {
  const user = auth.currentUser;
  if (!user || !user.photoURL) {
    alert("No photo to delete âŒ");
    return;
  }

  const storageRef = ref(storage, `profilePhotos/${user.uid}`);
  try {
    await deleteObject(storageRef).catch(() => {}); // delete file
    await updateProfile(user, { photoURL: null }); // clear profile photo
    displayNameAvatar(sessionStorage.getItem("fullname")); // fallback avatar
    alert("Profile photo deleted âœ…");
  } catch (err) {
    console.error(err);
    alert("Failed to delete photo âŒ");
  }
});


// Logout
document.getElementById("logoutBtn").addEventListener("click", async ()=>{
  await auth.signOut();
  sessionStorage.clear();
  window.location.href="home  .html";
});

// Sidebar toggle
const toggleBtn = document.getElementById("toggleBtn");
const sidebar = document.getElementById("sidebar");
const mainContent = document.getElementById("mainContent");
toggleBtn.addEventListener("click", ()=>{
  sidebar.classList.toggle("active");
  mainContent.classList.toggle("shift");
});
</script>
</body>
</html>  