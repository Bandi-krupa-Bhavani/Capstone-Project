<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Password & Security</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="css/passw-sec.css">
</head>
<body>
 <header>
    <div class="logo">
        <i class="fas fa-book"></i> BookVerse
    </div>
</header>
<div class="sidebar" id="sidebar">
  <a href="dashboard.html"><i class="fa-solid fa-house"></i> Dashboard</a>
  <a href="profile.html"><i class="fa-solid fa-user"></i> Profile</a>
  <a href="library.html"><i class="fa-solid fa-book-open"></i> My Library</a>
  <a href="home.html"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
</div>

<button class="toggle-btn" id="toggleBtn">‚ò∞</button>
<div class="security-form">
  <h2>üîí Password & Security</h2>

  <!-- Box 1: Change Password -->
  <div class="box-section">
    <h3>Change Password</h3>
    <div class="form-group">
      <label>Current Password</label>
       <div class="password-field">
      <input type="password" id="currentPassword" placeholder="Enter current password">
      <i class="fa-solid fa-eye-slash password-toggle"></i>
    </div>
    <div class="info" id="currentPasswordMsg"></div> <!-- Added -->
  </div>
    <div class="form-group">
      <label>New Password</label>
       <div class="password-field">
      <input type="password" id="newPassword" placeholder="Enter new password">
      <i class="fa-solid fa-eye-slash password-toggle"></i>
    </div></div>
    <div class="form-group">
      <label>Confirm New Password</label>
       <div class="password-field">
      <input type="password" id="confirmPassword" placeholder="Confirm new password">
      <i class="fa-solid fa-eye-slash password-toggle"></i>
    </div>
    <div class="info" id="confirmPasswordMsg"></div> <!-- Added -->
  </div>
    <button id="updatePasswordBtn">Update Password</button>
    <div class="info" id="passwordMessage"></div>
  </div>

  <!-- Box 2: Account Management -->
  <div class="box-section">
    <h3>Account Management</h3>
    <p style="font-size:14px;">You can permanently delete your account and all associated data.</p>
    <button class="delete-btn" id="deleteAccountBtn">Delete Account</button>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="confirmModal">
  <div class="modal-content">
    <h4>Are you sure?</h4>
    <p>Your account will be permanently deleted.This action cannot be undone.</p>
    <button id="confirmDeleteBtn" class="delete-btn">Yes, Delete</button>
    <button class="cancel-btn" id="cancelDeleteBtn">Cancel</button>
  </div>
</div>

<script type="module">
import { auth } from "./firebase-config.js";
import {
  updatePassword,
  EmailAuthProvider,
  reauthenticateWithCredential,
  deleteUser
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

// Select elements
const currentPasswordInput = document.getElementById("currentPassword");
const newPasswordInput = document.getElementById("newPassword");
const confirmPasswordInput = document.getElementById("confirmPassword");
const currentPasswordMsg = document.getElementById("currentPasswordMsg");
const confirmPasswordMsg = document.getElementById("confirmPasswordMsg");
const globalMsg = document.getElementById("passwordMessage");
const updateBtn = document.getElementById("updatePasswordBtn");

// Clear current password error when typing again
currentPasswordInput.addEventListener("input", () => {
  currentPasswordMsg.innerText = "";
});

// Disable button initially
updateBtn.disabled = true;
updateBtn.style.opacity = "0.6";
updateBtn.style.cursor = "not-allowed";

// ‚úÖ Real-time password validation
function validatePasswords() {
  confirmPasswordMsg.innerText = "";
  globalMsg.innerText = "";

  const current = currentPasswordInput.value;
  const newPass = newPasswordInput.value;
  const confirm = confirmPasswordInput.value;

  if (!newPass || !confirm) {
    updateBtn.disabled = true;
    updateBtn.style.opacity = "0.6";
    updateBtn.style.cursor = "not-allowed";
    return;
  }

  if (newPass !== confirm) {
    confirmPasswordMsg.innerText = "‚ùå Passwords do not match.";
    confirmPasswordMsg.style.color = "red";
    updateBtn.disabled = true;
    updateBtn.style.opacity = "0.6";
    updateBtn.style.cursor = "not-allowed";
    return;
  } else {
    confirmPasswordMsg.innerText = "";
  }

  if (current && current === newPass) {
    globalMsg.innerText = "‚ö†Ô∏è New password must be different from the current password.";
    globalMsg.style.color = "red";
    updateBtn.disabled = true;
    updateBtn.style.opacity = "0.6";
    updateBtn.style.cursor = "not-allowed";
    return;
  }

  updateBtn.disabled = false;
  updateBtn.style.opacity = "1";
  updateBtn.style.cursor = "pointer";
}

currentPasswordInput.addEventListener("input", validatePasswords);
newPasswordInput.addEventListener("input", validatePasswords);
confirmPasswordInput.addEventListener("input", validatePasswords);

// ‚úÖ Update password logic
updateBtn.addEventListener("click", async () => {
  const user = auth.currentUser;
  const currentPassword = currentPasswordInput.value;
  const newPassword = newPasswordInput.value;

  currentPasswordMsg.innerText = "";
  globalMsg.innerText = "";

  if (!user) {
    globalMsg.innerText = "You must be logged in to change password.";
    globalMsg.style.color = "red";
    return;
  }

  try {
    const credential = EmailAuthProvider.credential(user.email, currentPassword);
    await reauthenticateWithCredential(user, credential);

    if (currentPassword === newPassword) {
      globalMsg.innerText = "‚ö†Ô∏è New password must be different from the current password.";
      globalMsg.style.color = "red";
      return;
    }

    await updatePassword(user, newPassword);
    globalMsg.innerText = "‚úÖ Password updated successfully!";
    globalMsg.style.color = "green";

    currentPasswordInput.value = "";
    newPasswordInput.value = "";
    confirmPasswordInput.value = "";
    updateBtn.disabled = true;
    updateBtn.style.opacity = "0.6";
    updateBtn.style.cursor = "not-allowed";
  } catch (error) {
    if (error.code === "auth/invalid-credential") {
      currentPasswordMsg.innerText = "‚ùå Current password is incorrect.";
      currentPasswordMsg.style.color = "red";
    } else if (error.code === "auth/weak-password") {
      globalMsg.innerText = "‚ö†Ô∏è Your new password is too weak. Try a stronger one.";
      globalMsg.style.color = "red";
    } else {
      globalMsg.innerText = "‚ö†Ô∏è Something went wrong. Please try again.";
      globalMsg.style.color = "red";
    }
  }
});

// ‚úÖ Delete account with redirect to login if reauth required
const modal = document.getElementById("confirmModal");
const modalContent = modal.querySelector(".modal-content");
const deleteBtn = document.getElementById("deleteAccountBtn");

deleteBtn.addEventListener("click", () => {
  modalContent.innerHTML = `
    <h4>Are you sure?</h4>
    <p>Your account will be permanently deleted. This action cannot be undone.</p>
    <button id="confirmDeleteBtn" class="delete-btn">Yes, Delete</button>
    <button class="cancel-btn" id="cancelDeleteBtn">Cancel</button>
  `;
  modal.style.display = "flex";

  document.getElementById("cancelDeleteBtn").addEventListener("click", () => {
    modal.style.display = "none";
  });

  document.getElementById("confirmDeleteBtn").addEventListener("click", async () => {
    const user = auth.currentUser;
    if (!user) {
      modalContent.innerHTML = `<p style="color:red;">‚ö†Ô∏è No user is signed in.</p>`;
      setTimeout(() => (modal.style.display = "none"), 2000);
      return;
    }

    try {
      await deleteUser(user);
      modalContent.innerHTML = `<h4 style="color:green;">‚úÖ Your account has been deleted successfully.</h4>`;
      setTimeout(() => (window.location.href = "home.html"), 2000);
    } catch (error) {
      if (error.code === "auth/requires-recent-login") {
        // Silently redirect to login page
        await auth.signOut();
        window.location.href = "login.html";
      } else {
        modalContent.innerHTML = `
          <h4 style="color:red;">‚ö†Ô∏è Error deleting account</h4>
          <p>${error.message}</p>
          <button class="cancel-btn" id="closeErrorBtn">Close</button>
        `;
        document.getElementById("closeErrorBtn").addEventListener("click", () => {
          modal.style.display = "none";
        });
      }
    }
  });
});

// ‚úÖ Password toggle
document.querySelectorAll(".password-toggle").forEach((icon) => {
  icon.addEventListener("click", () => {
    const input = icon.previousElementSibling;
    if (input.type === "password") {
      input.type = "text";
      icon.classList.replace("fa-eye-slash", "fa-eye");
    } else {
      input.type = "password";
      icon.classList.replace("fa-eye", "fa-eye-slash");
    }
  });
});

// ‚úÖ Sidebar toggle
document.getElementById("toggleBtn").addEventListener("click", () => {
  document.getElementById("sidebar").classList.toggle("active");
  document.body.classList.toggle('sidebar-active');
});
</script>


</body>
</html>