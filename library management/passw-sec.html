<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Password & Security</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="css/passw-sec.css">
</head>
<body>
 <header>
    <div class="logo">
        <i class="fas fa-book"></i> BookVerse
    </div>
</header>
<div class="sidebar" id="sidebar">
  <a href="dashboard.html"><i class="fa-solid fa-house"></i> Dashboard</a>
  <a href="profile.html"><i class="fa-solid fa-user"></i> Profile</a>
  <a href="library.html"><i class="fa-solid fa-book-open"></i> My Library</a>
  <a href="home.html"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
</div>

<button class="toggle-btn" id="toggleBtn">â˜°</button>
<div class="security-form">
  <h2>ðŸ”’ Password & Security</h2>

  <!-- Box 1: Change Password -->
  <div class="box-section">
    <h3>Change Password</h3>
    <div class="form-group">
      <label>Current Password</label>
      <input type="password" id="currentPassword" placeholder="Enter current password">
          <i class="fa-solid fa-eye-slash password-toggle" id="togglePassword"></i>
    </div>
    <div class="form-group">
      <label>New Password</label>
      <input type="password" id="newPassword" placeholder="Enter new password">
          <i class="fa-solid fa-eye-slash password-toggle" id="togglePassword"></i>
    </div>
    <div class="form-group">
      <label>Confirm New Password</label>
      <input type="password" id="confirmPassword" placeholder="Confirm new password">
          <i class="fa-solid fa-eye-slash password-toggle" id="togglePassword"></i>
    </div>
    <button id="updatePasswordBtn">Update Password</button>
    <div class="info" id="passwordMessage"></div>
  </div>

  <!-- Box 2: Account Management -->
  <div class="box-section">
    <h3>Account Management</h3>
    <p style="font-size:14px;">You can permanently delete your account and all associated data.</p>
    <button class="delete-btn" id="deleteAccountBtn">Delete Account</button>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="confirmModal">
  <div class="modal-content">
    <h4>Are you sure?</h4>
    <p>This action cannot be undone.</p>
    <button id="confirmDeleteBtn" class="delete-btn">Yes, Delete</button>
    <button class="cancel-btn" id="cancelDeleteBtn">Cancel</button>
  </div>
</div>

<script type="module">
import { auth } from "./firebase-config.js";
import {
  onAuthStateChanged,
  updatePassword,
  EmailAuthProvider,
  reauthenticateWithCredential,
  deleteUser
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";


// Update password
document.getElementById("updatePasswordBtn").addEventListener("click", async () => {
  const user = auth.currentUser;
  const currentPassword = document.getElementById("currentPassword").value;
  const newPassword = document.getElementById("newPassword").value;
  const confirmPassword = document.getElementById("confirmPassword").value;
  const msg = document.getElementById("passwordMessage");

  if (!user) {
    msg.innerText = "You must be logged in to change password.";
    msg.style.color = "red";
    return;
  }

  if (newPassword !== confirmPassword) {
    msg.innerText = "New passwords do not match!";
    msg.style.color = "red";
    return;
  }

  try {
    const credential = EmailAuthProvider.credential(user.email, currentPassword);
    await reauthenticateWithCredential(user, credential);
    await updatePassword(user, newPassword);
    msg.innerText = "Password updated successfully!";
    msg.style.color = "green";
  } catch (error) {
    msg.innerText = "Error: " + error.message;
    msg.style.color = "red";
  }
});

// Delete account with modal confirmation
const modal = document.getElementById("confirmModal");
document.getElementById("deleteAccountBtn").addEventListener("click", () => {
  modal.style.display = "flex";
});

document.getElementById("cancelDeleteBtn").addEventListener("click", () => {
  modal.style.display = "none";
});

document.getElementById("confirmDeleteBtn").addEventListener("click", async () => {
  const user = auth.currentUser;
  if (!user) return alert("No user is signed in.");

  try {
    await deleteUser(user);
    alert("Your account has been deleted.");
    window.location.href = "index.html";
  } catch (error) {
    alert("Error: " + error.message);
  }
});

// âœ… Password toggle
  togglePassword.addEventListener("click", () => {
    const type = loginPassword.getAttribute("type") === "password" ? "text" : "password";
    loginPassword.setAttribute("type", type);
    togglePassword.classList.toggle("fa-eye");
    togglePassword.classList.toggle("fa-eye-slash");
  });

// Sidebar toggle
const toggleBtn = document.getElementById("toggleBtn");
const sidebar = document.getElementById("sidebar");
toggleBtn.addEventListener("click", () => {
  sidebar.classList.toggle("active");
});

</script>

</body>
</html>