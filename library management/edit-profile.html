<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Edit Profile - BookVerse</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="css/edit-profile.css">
</head>
<body>
  <header>
    <div class="logo">
        <i class="fas fa-book"></i> BookVerse
    </div>
</header>
<div class="sidebar" id="sidebar">
  <a href="dashboard.html"><i class="fa-solid fa-house"></i> Dashboard</a>
  <a href="profile.html"><i class="fa-solid fa-user"></i> Profile</a>
  <a href="library.html"><i class="fa-solid fa-book-open"></i> My Library</a>
  <a href="home.html"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
</div>

<button class="toggle-btn" id="toggleBtn">☰</button>
<div class="profile-form">
  <h2>Edit Profile</h2>

  <div class="form-group">
    <label for="name">Full Name</label>
    <input type="text" id="name" placeholder="Enter your full name">
    <small id="nameError"></small>
  </div>

  <div class="form-group">
    <label for="email">Email</label>
    <input type="email" id="email" readonly>
  </div>

  <div class="form-group">
    <label for="phone">Phone Number</label>
    <input type="text" id="phone" placeholder="Enter your phone number">
    <small id="phoneError"></small>
  </div>

  <div class="form-group">
    <label for="about">About Me</label>
    <textarea id="about" rows="4" placeholder="Tell us about yourself..."></textarea>
  </div>

  <div class="form-group">
    <label>Gender</label>
    <div class="gender-options">
      <div class="gender-card" data-value="Male">♂️<br>Male</div>
      <div class="gender-card" data-value="Female">♀️<br>Female</div>
      <div class="gender-card" data-value="Other">⚧️<br>Other</div>
    </div>
    <small id="genderError"></small>
  </div>
  <input type="hidden" id="genderInput" value="">

  <button id="saveBtn">Update Profile</button>
  <small id="successMessage" style="color:green;"></small>
</div>

<script type="module">
import { auth, db } from "./firebase-config.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Elements
const nameInput = document.getElementById("name");
const emailInput = document.getElementById("email");
const phoneInput = document.getElementById("phone");
const aboutInput = document.getElementById("about");
const saveBtn = document.getElementById("saveBtn");
const genderCards = document.querySelectorAll(".gender-card");
const genderInput = document.getElementById("genderInput");

const nameError = document.getElementById("nameError");
const phoneError = document.getElementById("phoneError");
const genderError = document.getElementById("genderError");
const successMessage = document.getElementById("successMessage");

// --- Gender selection (only 1 selectable) ---
genderCards.forEach(card => {
  card.addEventListener("click", () => {
    genderCards.forEach(c => c.classList.remove("selected"));
    card.classList.add("selected");
    genderInput.value = card.dataset.value;
    genderError.textContent = "";
  });
});

// --- Validation function ---
function validateField(input, regex, errorElement, message) {
  if (input.value.trim() !== "" && !regex.test(input.value.trim())) {
    errorElement.textContent = message;
    input.classList.add("error-input");
    return false;
  } else {
    errorElement.textContent = "";
    input.classList.remove("error-input");
    return true;
  }
}

// --- Real-time validation ---
nameInput.addEventListener("input", () => {
  validateField(nameInput, /^[A-Za-z\s]+$/, nameError, "Only letters allowed.");
});
phoneInput.addEventListener("input", () => {
  validateField(phoneInput, /^\d{10}$/, phoneError, "Phone must be 10 digits.");
});

// --- Load user data ---
onAuthStateChanged(auth, async (user) => {
  if (!user) return window.location.href = "login.html";

  const userRef = doc(db, "users", user.uid);
  try {
    const userSnap = await getDoc(userRef);
    if (userSnap.exists()) {
      const data = userSnap.data();
      nameInput.value = data.fullname || "";
      emailInput.value = user.email || "";
      phoneInput.value = data.phone || "";
      aboutInput.value = data.about || "";

      if (data.gender) {
        genderCards.forEach(c => {
          c.classList.remove("selected");
          if (c.dataset.value === data.gender) {
            c.classList.add("selected");
            genderInput.value = data.gender;
          }
        });
      }
    }
  } catch(err) { console.error("Error fetching user data:", err); }
});

// --- Save profile ---
saveBtn.addEventListener("click", async () => {
  const user = auth.currentUser;
  if (!user) return;

  const nameVal = nameInput.value.trim();
  const phoneVal = phoneInput.value.trim();
  const aboutVal = aboutInput.value.trim();
  const genderVal = genderInput.value;

  // Validate
  const isNameValid = validateField(nameInput, /^[A-Za-z\s]+$/, nameError, "Only letters allowed.");
  const isPhoneValid = validateField(phoneInput, /^\d{10}$/, phoneError, "Phone must be 10 digits.");
  const isGenderValid = genderVal !== "";
  if (!isGenderValid) genderError.textContent = "Please select a gender.";

  if (!isNameValid || !isPhoneValid || !isGenderValid) return;

  const userRef = doc(db, "users", user.uid);
  try {
    await updateDoc(userRef, {
      fullname: nameVal,
      phone: phoneVal,
      about: aboutVal,
      gender: genderVal
    });
    successMessage.textContent = "✅ Profile updated successfully!";
    successMessage.style.color = "green";
  } catch(err) {
    console.error("Error updating profile:", err);
    successMessage.textContent = "❌ Failed to update profile!";
    successMessage.style.color = "red";
  }
});
// Sidebar toggle
const toggleBtn = document.getElementById("toggleBtn");
const sidebar = document.getElementById("sidebar");
const mainContent = document.getElementById("mainContent");
toggleBtn.addEventListener("click", ()=>{
  sidebar.classList.toggle("active");
  mainContent.classList.toggle("shift");
});
</script>

</body>
</html>
