<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Edit Profile - BookVerse</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="css/edit-profile.css">
</head>
<body>
  <header>
    <div class="logo">
        <i class="fas fa-book"></i> BookVerse
    </div>
</header>
<div class="sidebar" id="sidebar">
  <a href="dashboard.html"><i class="fa-solid fa-house"></i> Dashboard</a>
  <a href="profile.html"><i class="fa-solid fa-user"></i> Profile</a>
  <a href="library.html"><i class="fa-solid fa-book-open"></i> My Library</a>
  <a href="home.html"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
</div>

<button class="toggle-btn" id="toggleBtn">☰</button>
<div class="profile-form">
  <h2>✏️  Edit Profile</h2>

  <div class="box-section">
  <div class="form-group">
    <label for="name">Full Name</label>
    <input type="text" id="name" placeholder="Enter your full name">
    <small id="nameError"></small>
  </div>

  <div class="form-group">
    <label for="email">Email</label>
    <input type="email" id="email" readonly>
  </div>

  <div class="form-group">
  <label for="phone">Phone Number</label>
  <input type="text" id="phone" placeholder="Enter your phone number" required>
  <small id="phoneError"></small>
</div>

  <div class="form-group">
    <label for="about">About Me</label>
    <textarea id="about" rows="4" placeholder="Tell us about yourself..."></textarea>
  </div>

  <div class="form-group">
    <label>Gender</label>
    <div class="gender-options">
      <div class="gender-card" data-value="Male">♂️<br>Male</div>
      <div class="gender-card" data-value="Female">♀️<br>Female</div>
      <div class="gender-card" data-value="Other">⚧️<br>Other</div>
    </div>
    <small id="genderError"></small>
  </div>
  <input type="hidden" id="genderInput" value="">

  <button id="saveBtn">Update Profile</button>
  <small id="successMessage" style="color:green;"></small>
</div>
</div>

<script type="module">
import { auth, db } from "./firebase-config.js";
import { onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Elements
const nameInput = document.getElementById("name");
const emailInput = document.getElementById("email");
const phoneInput = document.getElementById("phone");
const aboutInput = document.getElementById("about");
const saveBtn = document.getElementById("saveBtn");
const genderCards = document.querySelectorAll(".gender-card");
const genderInput = document.getElementById("genderInput");

const nameError = document.getElementById("nameError");
const phoneError = document.getElementById("phoneError");
const genderError = document.getElementById("genderError");
const successMessage = document.getElementById("successMessage");

// Gender selection
genderCards.forEach(card => {
  card.addEventListener("click", () => {
    genderCards.forEach(c => c.classList.remove("selected"));
    card.classList.add("selected");
    genderInput.value = card.dataset.value;
    genderError.textContent = "";
  });
});

// --- Real-time Validation ---
// Name
nameInput.addEventListener("input", () => {
  const val = nameInput.value.trim();
  if (val === "") {
    nameError.textContent = "Name is required.";
    nameInput.classList.add("error-input");
  } else if (!/^[A-Za-z\s]+$/.test(val)) {
    nameError.textContent = "Only letters allowed.";
    nameInput.classList.add("error-input");
  } else {
    nameError.textContent = "";
    nameInput.classList.remove("error-input");
  }
});

// Phone
phoneInput.addEventListener("input", () => {
  const val = phoneInput.value.trim();
  if (val === "") {
    phoneError.textContent = "Phone number is required.";
    phoneInput.classList.add("error-input");
  } else if (!/^\d*$/.test(val)) {
    phoneError.textContent = "Only digits allowed.";
    phoneInput.classList.add("error-input");
  } else if (val.length !== 10) {
    phoneError.textContent = "Phone must be 10 digits.";
    phoneInput.classList.add("error-input");
  } else {
    phoneError.textContent = "";
    phoneInput.classList.remove("error-input");
  }
});

// Load user data
onAuthStateChanged(auth, async (user) => {
  if (!user) return (window.location.href = "login.html");

  try {
    const usersRef = doc(db, "users", user.uid);
    const usersSnap = await getDoc(usersRef);
    const editRef = doc(db, "editProfiles", user.uid);
    const editSnap = await getDoc(editRef);

    if (usersSnap.exists()) {
      const data = usersSnap.data();
      nameInput.value = data.fullname || "";
      emailInput.value = data.email || "";
      phoneInput.value = data.phone || "";
    }

    if (editSnap.exists()) {
      const data = editSnap.data();
      nameInput.value = data.fullname || nameInput.value;
      phoneInput.value = data.phone || phoneInput.value;
      aboutInput.value = data.about || "";
      if (data.gender) {
        genderCards.forEach(c => {
          c.classList.remove("selected");
          if (c.dataset.value === data.gender) {
            c.classList.add("selected");
            genderInput.value = data.gender;
          }
        });
      }
    }

  } catch (err) {
    console.error("Error fetching user data:", err);
  }
});

// --- Save Profile ---
saveBtn.addEventListener("click", async () => {
  const user = auth.currentUser;
  if (!user) return;

  const nameVal = nameInput.value.trim();
  const phoneVal = phoneInput.value.trim();
  const aboutVal = aboutInput.value.trim();
  const genderVal = genderInput.value;

  let isValid = true;

  // Validate Name
  if (nameVal === "") {
    nameError.textContent = "Name is required.";
    nameInput.classList.add("error-input");
    isValid = false;
  } else if (!/^[A-Za-z\s]+$/.test(nameVal)) {
    nameError.textContent = "Only letters allowed.";
    nameInput.classList.add("error-input");
    isValid = false;
  } else {
    nameError.textContent = "";
    nameInput.classList.remove("error-input");
  }

  // Validate Phone
  if (phoneVal === "") {
    phoneError.textContent = "Phone number is required.";
    phoneInput.classList.add("error-input");
    isValid = false;
  } else if (!/^\d{10}$/.test(phoneVal)) {
    phoneError.textContent = "Phone must be 10 digits.";
    phoneInput.classList.add("error-input");
    isValid = false;
  } else {
    phoneError.textContent = "";
    phoneInput.classList.remove("error-input");
  }

  // Validate Gender
  if (genderVal === "") {
    genderError.textContent = "Please select a gender.";
    isValid = false;
  } else {
    genderError.textContent = "";
  }

  if (!isValid) return;

  // Save to Firebase
  const editRef = doc(db, "editProfiles", user.uid);
  try {
    await setDoc(editRef, {
      fullname: nameVal,
      phone: phoneVal,
      about: aboutVal,
      gender: genderVal,
      updatedAt: new Date(),
      email: user.email
    });

    await updateProfile(user, { displayName: nameVal });

    successMessage.textContent = "✅ Profile updated successfully!";
    successMessage.style.color = "green";
  } catch (err) {
    console.error("Error updating profile:", err);
    successMessage.textContent = "❌ Failed to update profile!";
    successMessage.style.color = "red";
  }
});

// Sidebar toggle
const toggleBtn = document.getElementById("toggleBtn");
const sidebar = document.getElementById("sidebar");
toggleBtn.addEventListener("click", () => {
  sidebar.classList.toggle("active");
});
</script>

</body>
</html>
