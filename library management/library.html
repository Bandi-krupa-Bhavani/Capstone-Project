<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Library | BookVerse</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="css/library.css">
</head>
<body>
  <header>
    <div class="header-left">
      <div class="logo"><i class="fa-solid fa-book"></i><span style="margin-left:6px;">BookVerse</span></div>
      <div id="welcomeName">Welcome</div>
    </div>

    <div class="header-right">
      <div id="dateTime" aria-live="polite" title="Current date and time">
        <span id="dtText">â€”</span>
        <small>IST</small>
      </div>
    </div>
  </header>

  <!-- Top Bar -->
  <div class="top-bar" id="topBar">
    <button class="toggle-btn" id="toggleBtn">â˜°</button>
    <div class="library-title">
      <h2>ðŸ“š My Library</h2>
      <p>Select a section to explore your collection.</p>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <a href="dashboard.html"><i class="fa-solid fa-house"></i> Dashboard</a>
    <a href="library.html" class="active"><i class="fa-solid fa-book-open"></i> My Library</a>
    <a href="profile.html"><i class="fa-solid fa-user"></i> Profile</a>
    <a href="home.html"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
  </div>

  <!-- Main Content -->
  <div class="content" id="mainContent">
    <div class="library-sections">
      <div class="section-card" onclick="window.location.href='continue-read.html'">
        <i class="fa-solid fa-clock"></i>
        <h3>Continue Reading</h3>
        <p>Pick up where you left off.</p>
      </div>

      <div class="section-card" onclick="window.location.href='fav.html'">
        <i class="fa-solid fa-heart"></i>
        <h3>My Favourites</h3>
        <p>View and manage your favourite books.</p>
      </div>
    </div>
  </div>
  
  <script type="module">
  import { auth, db } from "./firebase-config.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { doc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const welcomeNameEl = document.getElementById('welcomeName'); // <div id="welcomeName">
  const dtText = document.getElementById('dtText'); 
document.addEventListener('DOMContentLoaded', () => {
  const toggleBtn = document.getElementById('toggleBtn');
  const sidebar = document.getElementById('sidebar');
  const mainContent = document.getElementById('mainContent');
  const topBar = document.getElementById('topBar');

  // If toggle button not present on a page, do nothing.
  if (!toggleBtn) return;

  // Toggle handler - safe: only toggles classes if the element exists
  toggleBtn.addEventListener('click', () => {
    if (sidebar) sidebar.classList.toggle('active');
    if (mainContent) mainContent.classList.toggle('shift');
    if (topBar) topBar.classList.toggle('shift');
  });
});
// --- Clock: write only into the dtText span so the small "IST" remains ---
  function formatKolkata(dt) {
    try {
      // human-friendly medium date + short time (Asia/Kolkata)
      return new Intl.DateTimeFormat('en-IN', {
        dateStyle: 'medium',
        timeStyle: 'short',
        timeZone: 'Asia/Kolkata'
      }).format(dt);
    } catch (e) {
      return dt.toLocaleString();
    }
  }
  function startClock() {
    function tick() {
      if (dtText) dtText.textContent = formatKolkata(new Date());
    }
    tick();
    setInterval(tick, 1000);
  }
  startClock();

  // --- Welcome name from Firestore (subcollection) with session fallback ---
  onAuthStateChanged(auth, async (user) => {
    // default fallback from sessionStorage (if any)
    const cached = sessionStorage.getItem('fullname') || null;
    if (!user) {
      welcomeNameEl.textContent = cached ? `Welcome! ${cached}` : 'Welcome';
      return;
    }

    // optimistic display
    let resolvedName = user.displayName || cached || 'Welcome';
    welcomeNameEl.textContent = `Welcome! ${resolvedName}`;

    // subscribe to subcollection doc: users/{uid}/editProfiles/profile
    try {
      const editRef = doc(db, 'users', user.uid, 'editProfiles', 'profile');
      onSnapshot(editRef, snap => {
        if (snap.exists() && snap.data().fullname) {
          resolvedName = snap.data().fullname;
        }
        welcomeNameEl.textContent = `Welcome! ${resolvedName}`;
        // cache small
        sessionStorage.setItem('fullname', resolvedName);
        sessionStorage.setItem('fullnameUpdatedAt', Date.now());
      }, async (err) => {
        console.warn('profile snapshot err', err);
        // fallback to a single get if snapshot fails
        try {
          const fallback = await getDoc(editRef);
          if (fallback.exists() && fallback.data().fullname) {
            resolvedName = fallback.data().fullname;
          }
        } catch (e) { /* ignore */ }
        welcomeNameEl.textContent = `Welcome, ${resolvedName}`;
      });
    } catch (e) {
      console.warn('load profile err', e);
      welcomeNameEl.textContent = `Welcome, ${resolvedName}`;
    }
  });

  </script>
</body>
</html>