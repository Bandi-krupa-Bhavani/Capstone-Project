<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Continue Reading | BookVerse</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root{
      --maxw:1200px; --bg-main: linear-gradient(to bottom, rgba(240,207,177,0.75), rgba(239,207,177,0.85));
      --accent: #c17c4a; --muted: #6b7280; --card-bg: rgba(255,255,255,0.6);
      --shadow-soft: 0 8px 30px rgba(12,18,30,0.06);
      --radius: 14px;
    }
    html,body{ height:100%; margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; background: var(--bg-main), url("css/assets/images/dashboard-image.avif") center/cover fixed no-repeat; color:#0f172a; -webkit-font-smoothing:antialiased;}

    /* header & sidebar (same look as fav.html) */
    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: rgba(62, 44, 32, 0.95);
      color: #F5E6D3;
      padding: 15px 50px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 10;
    }
    header .logo { font-size: 22px; font-weight: bold; color: #F5E6D3; }

    .top-bar { display:flex; align-items:center; gap:15px; padding:90px 40px 20px 40px; transition: margin-left .3s ease; }
    .top-bar.shift{ margin-left:270px; }
    .toggle-btn{ position: fixed; top:70px; left:15px; font-size:25px; background: rgba(62,44,32,0.95); color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; z-index:1000; }

    .sidebar{ position: fixed; top:60px; left:-250px; width:250px; height:100%; background: transparent; padding-top:60px; transition:left .3s ease; }
    .sidebar.active{ left:0; }
    .sidebar a{ display:block; padding:15px 20px; color: rgba(62,44,32,0.95); text-decoration:none; }
    .sidebar a:hover{ background: rgba(255,255,255,0.06); }

    /* content area uses same max-width & margins as fav.html */
    .content{ margin-left:0; transition: margin-left .3s ease; padding:20px 40px; max-width:var(--maxw); margin:90px auto 80px auto; }

    /* ====== IMPORTANT: using #bookList (same as fav.html) ====== */
    #bookList {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 18px;
      margin-top: 30px;
      padding: 8px 0 40px 0;
      min-height: 220px;
      position: relative;
    }

    /* Card styles (copied from your fav.css snippet) */
    #bookList .card {
      position: relative;
      display: flex;
      gap: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.98), #fff);
      border-radius: 14px;
      padding: 16px;
      align-items: flex-start;
      box-shadow: 0 8px 30px rgba(12,18,30,0.06);
      transition: transform .16s ease, box-shadow .16s ease;
      border: 1px solid rgba(14,20,30,0.03);
      overflow: visible;
    }
    #bookList .card:hover { transform: translateY(-6px); box-shadow: 0 20px 46px rgba(12,18,30,0.14); }

    #bookList .accent-strip {
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 6px;
      border-top-left-radius: 14px;
      border-bottom-left-radius: 14px;
      background: linear-gradient(180deg,#d4a373,#c17c4a);
    }

    #bookList .card-left { width: 120px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
    #bookList .cover-wrap {
      width:104px; height:104px; border-radius:50%; display:grid; place-items:center;
      background: linear-gradient(135deg,#fff,#fff9f0);
      box-shadow: 0 8px 20px rgba(12,20,30,0.08);
      border: 6px solid rgba(255,255,255,0.6);
      overflow:hidden;
    }
    #bookList .cover-wrap img{ width:100%; height:100%; object-fit:contain; display:block; }

    #bookList .card-body { flex:1; min-width:0; display:flex; flex-direction:column; gap:6px; }
    #bookList .card-title { font-weight:800; font-size:1.02rem; color:#0f172a; margin:0; line-height:1.18; }
    #bookList .card-author { color:#6b7280; font-size:.92rem; display:flex; align-items:center; gap:8px; margin-top:2px; }
    #bookList .card-meta { display:flex; gap:10px; align-items:center; color:#6b7280; font-size:.86rem; margin-top:4px; }
    #bookList .chips { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    #bookList .chip { font-weight:700; font-size:0.78rem; padding:6px 8px; border-radius:999px; background:linear-gradient(180deg,#fff,#fff8f0); color:#5a3825; border:1px solid rgba(0,0,0,0.03); }
    #bookList .actions { display:flex; gap:8px; margin-top:14px; flex-wrap:wrap; }
    #bookList .btn { display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border:none; border-radius:10px; font-weight:700; cursor:pointer; text-decoration:none; transition: all .2s ease; }
    #bookList .btn.read { background: linear-gradient(90deg,#7c3aed,#4f46e5); color:white; }
    #bookList .btn.download { background: linear-gradient(90deg,#d4a373,#c17c4a); color:white; }
    #bookList .btn.remove { background: linear-gradient(90deg,#ffd166,#ff7b7b); color:white; }

    /* Empty banner exactly like fav.html */
    .empty-msg {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      max-width: 820px;
      background: linear-gradient(90deg, rgba(255,255,255,0.9), rgba(255,247,237,0.95));
      border: 2px solid rgba(212,163,115,0.35);
      border-radius: 16px;
      padding: 28px 32px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.08);
      text-align: center;
      font-family: 'Playfair Display', serif;
      font-size: 1.15rem;
      font-weight: 600;
      color: #5a3d2b;
      line-height: 1.4;
      letter-spacing: 0.3px;
      opacity: 0.98;
      backdrop-filter: blur(6px) saturate(120%);
      transition: all 0.28s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:14px;
    }

    .empty-cta {
      padding: 8px 12px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(90deg,#7c3aed,#4f46e5);
      color: white;
      font-weight:700;
      cursor:pointer;
    }

    @media (max-width:720px) {
      #bookList { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:14px; padding:12px; }
      #bookList .card { flex-direction: column; align-items:center; text-align:center; }
      #bookList .accent-strip { display:none; }
      #bookList .card-left { width:auto; }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo"><i class="fas fa-book"></i> BookVerse</div>
  </header>

  <div class="top-bar" id="topBar">
    <button class="toggle-btn" id="toggleBtn">â˜°</button>
    <div class="library-title">
      <h2>ðŸ“– Continue Reading</h2>
      <p>Pick up where you left off in your books.</p>
    </div>
  </div>

  <div class="sidebar" id="sidebar">
    <a href="dashboard.html"><i class="fa-solid fa-house"></i> Dashboard</a>
    <a href="profile.html"><i class="fa-solid fa-user"></i> Profile</a>
    <a href="library.html"><i class="fa-solid fa-book-open"></i> My Library</a>
    <a href="continue-read.html" class="active"><i class="fa-solid fa-clock"></i> Continue Reading</a>
    <a href="fav.html"><i class="fa-solid fa-heart"></i> My Favourites</a>
    <a href="home.html"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
  </div>

  <main class="content" id="mainContent" aria-live="polite">
    <!-- Note: #bookList used here to match fav.html exactly -->
    <div id="bookList" aria-live="polite" role="list"></div>

    <div id="empty" class="empty-msg" style="display:none;" role="status" aria-atomic="true">
      <i class="fa-solid fa-clock" style="color:#c17c4a; font-size:1.6rem;"></i>
      <div>No books in Continue Reading â€” open a book from the library to start reading and it will appear here.</div>
    </div>
  </main>

  <script type="module">
    // Keep same keys as other pages
    const CKEY = "bookverse_continue";
    const bookListEl = document.getElementById('bookList');
    const emptyEl = document.getElementById('empty');

    function getContinueLocal(){ return JSON.parse(localStorage.getItem(CKEY) || "[]"); }
    function setContinueLocal(arr){ localStorage.setItem(CKEY, JSON.stringify(arr)); try{ localStorage.setItem('__cont_sync', Date.now().toString()); }catch(e){} }
    function removeContinueLocal(id){ const arr = getContinueLocal().filter(x=>x.id!==id); setContinueLocal(arr); renderLocal(); }

    // Build DOM card (same structure & classes as fav.html)
    function buildCard(b, removeHandler){
      const card = document.createElement('article'); card.className='card'; card.setAttribute('role','listitem');

      const stripe = document.createElement('div'); stripe.className='accent-strip'; card.appendChild(stripe);

      const left = document.createElement('div'); left.className='card-left';
      const wrap = document.createElement('div'); wrap.className='cover-wrap';
      const img = document.createElement('img'); img.src = b.cover || 'https://via.placeholder.com/120x120?text=Book'; img.alt=b.title||'Cover';
      img.onerror = ()=> img.src='https://via.placeholder.com/120x120?text=Book';
      wrap.appendChild(img); left.appendChild(wrap);

      const body = document.createElement('div'); body.className='card-body';
      const title = document.createElement('div'); title.className='card-title'; title.textContent = b.title || 'Untitled';
      const author = document.createElement('div'); author.className='card-author'; author.innerHTML = `<i class="fa-solid fa-user"></i> ${b.author || 'Unknown'}`;
      const meta = document.createElement('div'); meta.className='card-meta'; meta.innerHTML = `<i class="fa-solid ${ (b.type==='pdf') ? 'fa-file-pdf' : 'fa-file-lines'}"></i> â€¢ ${(b.type||'FILE').toUpperCase()} â€¢ <i class="fa-regular fa-calendar"></i> ${b.year||''}`;

      const chips = document.createElement('div'); chips.className='chips';
      (b.tags||[]).slice(0,4).forEach(t=>{ const c=document.createElement('div'); c.className='chip'; c.textContent=t; chips.appendChild(c); });

      const actions = document.createElement('div'); actions.className='actions';
      const read = document.createElement('a'); read.className='btn read'; read.href=b.href||'#'; read.target='_blank'; read.rel='noopener'; read.innerHTML='<i class="fa-solid fa-book-open"></i> Continue';
      read.addEventListener('click',(ev)=>{ ev.preventDefault(); const arr=getContinueLocal(); const idx=arr.findIndex(x=>x.id===b.id); if(idx!==-1){ arr[idx].lastOpened=Date.now(); setContinueLocal(arr);} window.open(b.href||'#','_blank','noopener'); renderLocal(); });

      const download = document.createElement('a'); download.className='btn download'; download.href=b.href||'#'; download.download=''; download.innerHTML='<i class="fa-solid fa-download"></i> Download';
      const rem = document.createElement('button'); rem.className='btn remove'; rem.type='button'; rem.innerHTML='<i class="fa-solid fa-trash"></i> Remove';
      rem.addEventListener('click',(ev)=>{ ev.preventDefault(); if(typeof removeHandler==='function'){ removeHandler(b.id);} });

      actions.appendChild(read); actions.appendChild(download); actions.appendChild(rem);

      // small progress if present
      if(typeof b.progress !== 'undefined'){
        const pcont = document.createElement('div'); pcont.className='progress-container';
        const pbar = document.createElement('div'); pbar.className='progress-bar'; pbar.style.width = Math.round((b.progress||0)*100) + '%';
        pcont.appendChild(pbar);
        const ptext = document.createElement('span'); ptext.className='progress-text'; ptext.textContent = Math.round((b.progress||0)*100) + '% completed';
        body.appendChild(pcont); body.appendChild(ptext);
      }

      body.appendChild(title); body.appendChild(author); body.appendChild(meta); body.appendChild(chips); body.appendChild(actions);
      card.appendChild(left); card.appendChild(body);
      return card;
    }

    // render local fallback
    function renderLocal(){
      const arr = getContinueLocal().slice().sort((a,b)=> (b.lastOpened||0)-(a.lastOpened||0));
      bookListEl.innerHTML = '';
      if(!arr.length){ emptyEl.style.display='flex'; return; } else { emptyEl.style.display='none'; }
      arr.forEach(b => bookListEl.appendChild(buildCard(b, (id)=> removeContinueLocal(id))));
    }

    // Firestore integration with same migration/subscription approach (optional)
    (async function initFirestore(){
      try {
        const fb = await import('./js/firebase-config.js');
        const authMod = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js');
        const fsMod = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        const { auth, db } = fb;
        const { onAuthStateChanged } = authMod;
        const { collection, query, onSnapshot, deleteDoc, doc, setDoc } = fsMod;

        let unsub=null, uid=null;
        const contRef = (u)=> collection(db,'users',u,'continueReading');
        const contDoc = (u,id)=> doc(db,'users',u,'continueReading',id);

        async function migrate(user){
          const local = getContinueLocal();
          if(!Array.isArray(local)||local.length===0) return;
          for(const b of local){ if(!b||!b.id) continue; try{ await setDoc(contDoc(user.uid,b.id), b, {merge:true}); }catch(e){ console.warn(e); } }
        }
        function subscribe(u){
          if(unsub) unsub();
          const q = query(contRef(u));
          unsub = onSnapshot(q, snap=>{
            const arr = snap.docs.map(d=>d.data());
            try{ localStorage.setItem(CKEY, JSON.stringify(arr)); }catch(e){}
            bookListEl.innerHTML = '';
            if(!arr.length){ emptyEl.style.display='flex'; return; } else { emptyEl.style.display='none'; }
            arr.sort((a,b)=> (b.lastOpened||0)-(a.lastOpened||0));
            arr.forEach(b => bookListEl.appendChild(buildCard(b, async (id)=> { try{ await deleteDoc(contDoc(u,id)); }catch(e){console.error(e);} } )));
          }, err=>{
            console.error('cont snapshot', err);
            renderLocal();
          });
        }

        onAuthStateChanged(auth, async user=>{
          if(user){ uid = user.uid; await migrate(user).catch(()=>{}); subscribe(uid); } else { uid=null; if(unsub){ unsub(); unsub=null;} renderLocal(); }
        });

        renderLocal();
      } catch(e){
        // firestore not available => local fallback
        console.warn('Firestore unavailable', e);
        renderLocal();
      }
    })();

    // storage event sync
    window.addEventListener('storage', (e)=>{ if(e.key===CKEY || e.key==='__cont_sync') renderLocal(); });

    // sidebar toggle
    document.addEventListener('DOMContentLoaded', ()=>{
      const toggleBtn = document.getElementById('toggleBtn');
      const sidebar = document.getElementById('sidebar');
      const content = document.querySelector('.content');
      const topBar = document.getElementById('topBar');
      if(toggleBtn){
        toggleBtn.addEventListener('click', ()=>{
          if(sidebar) sidebar.classList.toggle('active');
          if(content) content.classList.toggle('shift');
          if(topBar) topBar.classList.toggle('shift');
        });
      }
    });

    // helper so other pages (cs-fund.html) can call to instantly add and show item
    window.BookVerse = window.BookVerse || {};
    window.BookVerse.addContinueLocal = function(book){
      try {
        const arr = getContinueLocal();
        if(!arr.some(x=>x.id===book.id)){ arr.unshift({...book,lastOpened:Date.now()}); setContinueLocal(arr); }
        else { const idx=arr.findIndex(x=>x.id===book.id); arr[idx] = {...arr[idx], ...book, lastOpened:Date.now()}; setContinueLocal(arr); }
        renderLocal();
      } catch(e){ console.warn(e); }
    };

  </script>
</body>
</html>
