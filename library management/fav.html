<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Favourites | BookVerse</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <!-- keep your original CSS file (background, sidebar, toggle) -->
  <link rel="stylesheet" href="css/fav.css">

  <!-- Card styles scoped to the favourites list so we don't change global layout -->
  <style>
    /* Scoped card styles that match the CS page card UI */
    #bookList {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 18px;
      margin-top: 30px;
      padding: 24px;
      min-height: 220px; /* ensure empty state vertical centering works well */
      position: relative;
    }

    #bookList .card {
      position: relative;
      display: flex;
      gap: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.98), #fff);
      border-radius: 14px;
      padding: 16px;
      align-items: flex-start;
      box-shadow: 0 8px 30px rgba(12,18,30,0.06);
      transition: transform .16s ease, box-shadow .16s ease;
      border: 1px solid rgba(14,20,30,0.03);
      overflow: visible;
    }
    #bookList .card:hover { transform: translateY(-6px); box-shadow: 0 20px 46px rgba(12,18,30,0.14); }

    /* accent left stripe */
    #bookList .accent-strip {
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 6px;
      border-top-left-radius: 14px;
      border-bottom-left-radius: 14px;
      background: linear-gradient(180deg,#d4a373,#c17c4a);
    }

    /* circular cover */
    #bookList .card-left { width: 120px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
    #bookList .cover-wrap{
      width:104px; height:104px; border-radius:50%; display:grid; place-items:center;
      background: linear-gradient(135deg,#fff,#fff9f0);
      box-shadow: 0 8px 20px rgba(12,20,30,0.08);
      border: 6px solid rgba(255,255,255,0.6);
      overflow:hidden;
    }
    #bookList .cover-wrap img{ width:100%; height:100%; object-fit:contain; display:block; }

    /* body */
    #bookList .card-body { flex:1; min-width:0; display:flex; flex-direction:column; gap:6px; }
    #bookList .card-title { font-weight:800; font-size:1.02rem; color:#0f172a; margin:0; line-height:1.18; }
    #bookList .card-author { color:#6b7280; font-size:.92rem; display:flex; align-items:center; gap:8px; margin-top:2px; }
    #bookList .card-meta { display:flex; gap:10px; align-items:center; color:#6b7280; font-size:.86rem; margin-top:4px; }

    /* tags */
    #bookList .chips { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    #bookList .chip { font-weight:700; font-size:0.78rem; padding:6px 8px; border-radius:999px; background:linear-gradient(180deg,#fff,#fff8f0); color:#5a3825; border:1px solid rgba(0,0,0,0.03); }

    /* actions */
    #bookList .actions { display:flex; gap:8px; margin-top:14px; flex-wrap:wrap; }
    #bookList .btn { display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border:none; border-radius:10px; font-weight:700; cursor:pointer; text-decoration:none; transition: all .2s ease; }
    #bookList .btn.read { background: linear-gradient(90deg,#7c3aed,#4f46e5); color:white; }
    #bookList .btn.download { background: linear-gradient(90deg,#d4a373,#c17c4a); color:white; }
    #bookList .btn.remove { background: linear-gradient(90deg,#ffd166,#ff7b7b); color:white; }

    /* responsive */
    @media (max-width:720px) {
      #bookList { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:14px; padding:12px; }
      #bookList .card { flex-direction: column; align-items:center; text-align:center; }
      #bookList .accent-strip { display:none; }
      #bookList .card-left { width:auto; }
    }

    /* ======= Empty state styling (centered + wide banner) ======= */
    .empty-msg {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      max-width: 820px;
      background: linear-gradient(90deg, rgba(255,255,255,0.9), rgba(255,247,237,0.95));
      border: 2px solid rgba(212,163,115,0.35);
      border-radius: 16px;
      padding: 28px 32px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.08);
      text-align: center;
      font-family: 'Playfair Display', serif;
      font-size: 1.15rem;
      font-weight: 600;
      color: #5a3d2b;
      line-height: 1.4;
      letter-spacing: 0.3px;
      opacity: 0.98;
      backdrop-filter: blur(6px) saturate(120%);
      transition: all 0.28s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:14px;
    }

    .empty-cta {
      padding: 8px 12px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(90deg,#7c3aed,#4f46e5);
      color: white;
      font-weight:700;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo"><i class="fas fa-book"></i> BookVerse</div>
  </header>

  <!-- Toggle + Title -->
  <div class="top-bar" id="topBar">
    <button class="toggle-btn" id="toggleBtn">☰</button>
    <div class="library-title">
      <h2>❤ My Favourites</h2>
      <p>View and manage your favourite books.</p>
    </div>
  </div>

  <!-- Sidebar (kept identical to your original) -->
  <div class="sidebar" id="sidebar">
    <a href="dashboard.html"><i class="fa-solid fa-house"></i> Dashboard</a>
    <a href="profile.html"><i class="fa-solid fa-user"></i> Profile</a>
    <a href="library.html"><i class="fa-solid fa-book-open"></i> My Library</a>
    <a href="continue-read.html"><i class="fa-solid fa-clock"></i> Continue Reading</a>
    <a href="fav.html" class="active"><i class="fa-solid fa-heart"></i> My Favourites</a>
    <a href="home.html"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
  </div>

  <!-- Main Content -->
  <div class="content" id="mainContent">
    <!-- This is where favorite cards render -->
    <div id="bookList" class="book-list" aria-live="polite"></div>
  </div>

  <script type="module">
  // ---------- fav.html script: migrate local -> Firestore and use Firestore when signed-in ----------
  // Assumes ./js/firebase-config.js exports { auth, db }
  // No popups/alerts. If user already signed-in on login.html, auth state will be available here.

  const FKEY = "bookverse_favs";
  const bookListEl = document.getElementById('bookList');

  // local helpers
  function getFavsLocal(){ return JSON.parse(localStorage.getItem(FKEY) || "[]"); }
  function setFavsLocal(arr){ localStorage.setItem(FKEY, JSON.stringify(arr)); }
  function removeFavLocal(id){ const arr = getFavsLocal().filter(x=>x.id!==id); setFavsLocal(arr); renderLocalFavs(); }
  function renderLocalFavs(){
    const arr = getFavsLocal();
    bookListEl.innerHTML = '';
    if(!arr.length){
      bookListEl.innerHTML = `
        <div class="empty-msg" role="status">
          <i class="fa-solid fa-heart-crack" style="color:#c17c4a; font-size:1.6rem;"></i>
          <div>No favourites yet — add books from the dashboard.</div>
        </div>`;
      return;
    }
    arr.forEach(b => {
      const card = buildCard(b, (id)=> removeFavLocal(id));
      bookListEl.appendChild(card);
    });
  }

  // DOM card builder
  function buildCard(b, removeHandler){
    const card = document.createElement('article'); card.className='card'; card.setAttribute('role','listitem');
    const stripe = document.createElement('div'); stripe.className='accent-strip'; card.appendChild(stripe);

    const left = document.createElement('div'); left.className='card-left';
    const coverWrap = document.createElement('div'); coverWrap.className='cover-wrap';
    const img = document.createElement('img'); img.alt = b.title || 'Book'; img.src = b.cover || 'https://via.placeholder.com/120x120?text=Book';
    img.onerror = ()=> img.src = 'https://via.placeholder.com/120x120?text=Book';
    coverWrap.appendChild(img); left.appendChild(coverWrap);

    const body = document.createElement('div'); body.className='card-body';
    const title = document.createElement('div'); title.className='card-title'; title.textContent = b.title || 'Untitled';
    const author = document.createElement('div'); author.className='card-author'; author.innerHTML = `<i class="fa-solid fa-user"></i> ${b.author || 'Unknown'}`;
    const meta = document.createElement('div'); meta.className='card-meta'; meta.innerHTML = `<i class="fa-solid fa-file-pdf"></i> ${(b.type||'PDF').toUpperCase()} • <i class="fa-regular fa-calendar"></i> ${b.year || ''}`;

    const chips = document.createElement('div'); chips.className='chips';
    (b.tags || []).slice(0,3).forEach(t => { const c = document.createElement('div'); c.className = 'chip'; c.textContent = t; chips.appendChild(c); });

    const actions = document.createElement('div'); actions.className='actions';
    const read = document.createElement('a'); read.className='btn read'; read.href = b.href || '#'; read.target = '_blank'; read.rel='noopener'; read.innerHTML = `<i class="fa-solid fa-book-open"></i> Read`;
    const download = document.createElement('a'); download.className='btn download'; download.href = b.href || '#'; download.download = ''; download.innerHTML = `<i class="fa-solid fa-download"></i> Download`;
    const rem = document.createElement('button'); rem.className='btn remove'; rem.type = 'button'; rem.innerHTML = `<i class="fa-solid fa-trash"></i> Remove`;
    rem.addEventListener('click', ()=> { if(typeof removeHandler === 'function') removeHandler(b.id); });

    actions.appendChild(read); actions.appendChild(download); actions.appendChild(rem);

    body.appendChild(title); body.appendChild(author); body.appendChild(meta); body.appendChild(chips); body.appendChild(actions);
    card.appendChild(left); card.appendChild(body);
    return card;
  }

  // ---------- Firestore integration (if available) ----------
  (async function initFirestoreIntegration(){
    try {
      const fb = await import('./js/firebase-config.js'); // your config module
      const authMod = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js');
      const fsMod = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');

      const { auth, db } = fb;
      const { onAuthStateChanged } = authMod;
      const { collection, query, onSnapshot, deleteDoc, doc, setDoc } = fsMod;

      let unsub = null;
      let currentUid = null;

      const favCollectionRef = (uid) => collection(db, 'users', uid, 'favorites');
      const favDocRef = (uid, id) => doc(db, 'users', uid, 'favorites', id);

      // migrate local -> firestore (called once after sign-in)
      async function migrateLocalToFirestore(user){
        try {
          const local = getFavsLocal();
          if(!Array.isArray(local) || local.length === 0) return;
          for(const b of local){
            if(!b || !b.id) continue;
            try { await setDoc(favDocRef(user.uid, b.id), b, { merge: true }); } catch(e){ console.warn('migrate single fail', e); }
          }
          // optional: clear localStorage after migration (commented out — remove comment to enable)
          // localStorage.removeItem(FKEY);
        } catch(e){ console.warn('migration err', e); }
      }

      // subscribe to user's favs collection and render
      function subscribe(uid){
        if(unsub) unsub();
        const q = query(favCollectionRef(uid));
        unsub = onSnapshot(q, snap => {
          const arr = snap.docs.map(d => d.data());
          bookListEl.innerHTML = '';
          if(!arr.length){
            bookListEl.innerHTML = `
              <div class="empty-msg" role="status">
                <i class="fa-solid fa-heart-crack" style="color:#c17c4a; font-size:1.6rem;"></i>
                <div>You don't have favourites yet — add some from the dashboard.</div>
              </div>`;
            return;
          }
          arr.forEach(docObj => {
            const card = buildCard(docObj, async (id) => {
              // remove from firestore only
              try { await deleteDoc(favDocRef(uid, id)); } catch(e){ console.error('delete fav error', e); }
            });
            bookListEl.appendChild(card);
          });
          // mirror remote to local (so user can see if offline later)
          try { localStorage.setItem(FKEY, JSON.stringify(arr)); } catch(e){}
        }, err => {
          console.error('fav snapshot err', err);
          // on error fallback to local
          renderLocalFavs();
        });
      }

      // listen auth state
      onAuthStateChanged(auth, async (user) => {
        if(user){
          currentUid = user.uid;
          // migrate local -> firestore silently
          await migrateLocalToFirestore(user).catch(()=>{});
          // subscribe to remote favourites
          subscribe(currentUid);
        } else {
          currentUid = null;
          if(unsub){ unsub(); unsub = null; }
          // not signed-in: show local fallback
          renderLocalFavs();
        }
      });

      // initial render while auth resolves
      renderLocalFavs();

    } catch(err){
      // firebase not available: show local fallback
      console.warn('Firebase unavailable in fav page, using local fallback', err);
      renderLocalFavs();
    }
  })();

  // Sidebar toggle behaviour (keeps your original)
  document.addEventListener('DOMContentLoaded', () => {
    const toggleBtn = document.getElementById('toggleBtn');
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const topBar = document.getElementById('topBar');

    if (toggleBtn) {
      toggleBtn.addEventListener('click', () => {
        sidebar.classList.toggle('active');
        mainContent.classList.toggle('shift');
        topBar.classList.toggle('shift');
      });
    }
  });

  // keep storage sync for local fallback
  window.addEventListener('storage', (e) => {
    if (e.key === FKEY || e.key === '__fv_sync') {
      // re-render local fallback if firebase not active
      try { renderLocalFavs(); } catch(e){ /* ignore */ }
    }
  });
  </script>
</body>
</html>
