<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BOOKVERSE â€” Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="css/dashboard.css" />
</head>
<body>
  <!-- Header (profile-style) -->
  <header>
    <div class="header-left">
      <div class="logo"><i class="fa-solid fa-book"></i><span style="margin-left:6px;">BookVerse</span></div>
      <div id="welcomeName">Welcome</div>
    </div>

    <div class="header-right">
      <div id="dateTime" aria-live="polite" title="Current date and time">
        <span id="dtText">â€”</span>
        <small>IST</small>
      </div>
    </div>
  </header>


  <!-- Toggle button (profile-like) -->
  <button class="toggle-btn" id="toggleBtn" aria-label="Toggle sidebar">â˜°</button>

  <!-- Sidebar -->
  <nav class="sidebar" id="sidebar" aria-label="Main navigation">
    <a href="dashboard.html" class="active"><i class="fa-solid fa-house"></i> Dashboard</a>
    <a href="library.html"><i class="fa-solid fa-book-open"></i> My Library</a>
    <a href="profile.html"><i class="fa-solid fa-user"></i> Profile</a>
    <a href="index.html"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
  </nav>

  <!-- Search below header -->
  <div class="search-wrap" id="searchWrap">
    <div class="search-container">
      <div class="search-box">
        <input id="searchInput" type="search" placeholder="Search books, authors, topics..." aria-label="Search books" autocomplete="off" />
        <i class="fa-solid fa-magnifying-glass"></i>
        <div id="searchResults" class="search-results" role="listbox" aria-label="Search results"></div>
      </div>
    </div>
  </div>

  <!-- Main content -->
  <main class="main" id="mainContent">
    <div class="container">
      <h2 class="section-title">ðŸ“š Explore Knowledge</h2>

      <section class="domain">
        <h3>Computer Science</h3>
        <div class="subgrid">
          <a class="subcard" href="cs-fund.html">
            <div class="icon-wrap"><i class="fa-solid fa-layer-group"></i></div>
            <div class="subcard-title">CS Fundamentals</div>
            <div class="subline">Core theory & concepts</div>
          </a>

          <a class="subcard" href="prog.html">
            <div class="icon-wrap"><i class="fa-solid fa-code"></i></div>
            <div class="subcard-title">Programming</div>
            <div class="subline">Hands-on coding</div>
          </a>

          <a class="subcard" href="adv-topics.html">
            <div class="icon-wrap"><i class="fa-solid fa-brain"></i></div>
            <div class="subcard-title">Advanced Topics</div>
            <div class="subline">ML, Systems, Theory</div>
          </a>
        </div>
      </section>
        <!-- ===== Domain: Engineering example ===== -->
        <div class="domain" aria-labelledby="eng-title">
          <h3 id="eng-title">Engineering</h3>

          <div class="subgrid">
            <div class="subcard-wrapper">
              <a class="subcard" href="civil.html" aria-label="Civil Engineering">
                <div class="icon-wrap"><i class="fa-solid fa-building"></i></div>
                <span>Civil Engineering</span>
                <div class="subline">Structures, design & Construction</div>
              </a>
            </div>

            <div class="subcard-wrapper">
              <a class="subcard" href="electrical.html" aria-label="Electrical Engineering">
                <div class="icon-wrap"><i class="fa-solid fa-plug"></i></div>
                <span>Electrical Engineering</span>
                <div class="subline">Circuits & power</div>
              </a>
            </div>

            <div class="subcard-wrapper">
              <a class="subcard" href="mechanical.html" aria-label="Mechanical Engineering">
                <div class="icon-wrap"><i class="fa-solid fa-gears"></i></div>
                <span>Mechanical Engineering</span>
                <div class="subline">Dynamics </div>
              </a>
            </div>
          </div>
        </div>

        <!-- ===== Domain: Others ===== -->
        <div class="domain" aria-labelledby="other-title">
          <h3 id="other-title">Others</h3>

          <div class="subgrid">
            <div class="subcard-wrapper">
              <a class="subcard" href="environment.html" aria-label="Environment">
                <div class="icon-wrap"><i class="fa-solid fa-leaf"></i></div>
                <span>Eco-Social</span>
                <div class="subline">Sustainability & ethics</div>
              </a>
            </div>

            <div class="subcard-wrapper">
              <a class="subcard" href="lifestyle.html" aria-label="Lifestyle">
                <div class="icon-wrap"><i class="fa-solid fa-heart"></i></div>
                <span>Lifestyle & Wellness</span>
                <div class="subline">Health & habits</div>
              </a>
            </div>

            <div class="subcard-wrapper">
              <a class="subcard" href="research-papers.html" aria-label="Research Papers">
                <div class="icon-wrap"><i class="fa-solid fa-file-lines"></i></div>
                <span>Research Papers</span>
                <div class="subline">Latest studies</div>
              </a>
            </div>
          </div>
        </div>
      <!-- add more domain sections here as needed -->
    </div>
  </main>

  <!-- ---------- Scripts ---------- -->
<script type="module">
  import { auth, db } from "./firebase-config.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { doc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const welcomeNameEl = document.getElementById('welcomeName'); // <div id="welcomeName">
  const dtText = document.getElementById('dtText');            // <span id="dtText">
  const toggleBtn = document.getElementById('toggleBtn');
  const sidebar = document.getElementById('sidebar');
  const searchWrap = document.getElementById('searchWrap');
  const mainEl = document.getElementById('mainContent');

  // --- Sidebar toggle + shift classes (keeps your behaviour) ---
  toggleBtn.addEventListener('click', () => {
    sidebar.classList.toggle('active');
    searchWrap.classList.toggle('shift');
    mainEl.classList.toggle('shift');
    document.body.classList.toggle('sidebar-open');
  });

  // close sidebar when clicking outside
  document.addEventListener('click', (e) => {
    if (!sidebar.contains(e.target) && !e.target.closest('.toggle-btn') && sidebar.classList.contains('active') && !e.target.closest('#toggleBtn')) {
      sidebar.classList.remove('active');
      searchWrap.classList.remove('shift');
      mainEl.classList.remove('shift');
      document.body.classList.remove('sidebar-open');
    }
  });

  // --- Clock: write only into the dtText span so the small "IST" remains ---
  function formatKolkata(dt) {
    try {
      // human-friendly medium date + short time (Asia/Kolkata)
      return new Intl.DateTimeFormat('en-IN', {
        dateStyle: 'medium',
        timeStyle: 'short',
        timeZone: 'Asia/Kolkata'
      }).format(dt);
    } catch (e) {
      return dt.toLocaleString();
    }
  }
  function startClock() {
    function tick() {
      if (dtText) dtText.textContent = formatKolkata(new Date());
    }
    tick();
    setInterval(tick, 1000);
  }
  startClock();

  // --- Welcome name from Firestore (subcollection) with session fallback ---
  onAuthStateChanged(auth, async (user) => {
    // default fallback from sessionStorage (if any)
    const cached = sessionStorage.getItem('fullname') || null;
    if (!user) {
      welcomeNameEl.textContent = cached ? `Welcome! ${cached}` : 'Welcome';
      return;
    }

    // optimistic display
    let resolvedName = user.displayName || cached || 'Welcome';
    welcomeNameEl.textContent = `Welcome! ${resolvedName}`;

    // subscribe to subcollection doc: users/{uid}/editProfiles/profile
    try {
      const editRef = doc(db, 'users', user.uid, 'editProfiles', 'profile');
      onSnapshot(editRef, snap => {
        if (snap.exists() && snap.data().fullname) {
          resolvedName = snap.data().fullname;
        }
        welcomeNameEl.textContent = `Welcome! ${resolvedName}`;
        // cache small
        sessionStorage.setItem('fullname', resolvedName);
        sessionStorage.setItem('fullnameUpdatedAt', Date.now());
      }, async (err) => {
        console.warn('profile snapshot err', err);
        // fallback to a single get if snapshot fails
        try {
          const fallback = await getDoc(editRef);
          if (fallback.exists() && fallback.data().fullname) {
            resolvedName = fallback.data().fullname;
          }
        } catch (e) { /* ignore */ }
        welcomeNameEl.textContent = `Welcome, ${resolvedName}`;
      });
    } catch (e) {
      console.warn('load profile err', e);
      welcomeNameEl.textContent = `Welcome, ${resolvedName}`;
    }
  });
</script>

  <!-- optional: page scripts for books/search (if present in your project) -->
  <script src="books.js"></script>
  <script src="dashboard-search.js" defer></script>
  <!--<script type="module" src="dashboard-search.js"></script>-->

</body>
</html>
