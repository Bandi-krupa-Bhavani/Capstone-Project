<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CS Fundamentals â€” BOOKVERSE</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  :root{
    --maxw:1200px; --bg-main: linear-gradient(to bottom, rgba(240,207,177,0.75), rgba(239,207,177,0.85));
    --accent: #c17c4a; --accent-2: #7c3aed; --muted: #6b7280;
    --card-bg: rgba(255,255,255,0.6); --shadow-soft: 0 8px 30px rgba(12,18,30,0.06); --radius: 14px; --accent-accent:#b7791f;
    --header-bg: rgba(62,44,32,0.95);
    --header-text: #F5E6D3;
  }
  html,body{ height:100%; margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; background: var(--bg-main), url("css/assets/images/dashboard-image.avif") center/cover fixed no-repeat; color:#0f172a; -webkit-font-smoothing:antialiased;}
  
  /* ---------- Header (profile-style) ---------- */
  header{
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 60px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding: 0 20px;
    background: var(--header-bg);
    color: var(--header-text);
    z-index: 1200;
    box-shadow: 0 6px 20px rgba(0,0,0,0.12);
  }
  .header-left, .header-right { display:flex; align-items:center; gap:12px; }
  .logo { display:flex; align-items:center; gap:8px; font-weight:700; font-size:20px; color:var(--header-text); }
  .logo i { font-size:20px; }
  #welcomeName { font-weight:600; color:var(--header-text); margin-left:15px; font-size:0.98rem; }
  #dateTime { font-size:0.9rem; color: rgba(245,230,211,0.95); padding:6px 10px; background: rgba(0,0,0,0.08); border-radius:8px; display:flex; align-items:center; gap:8px; }
  #dateTime small { font-size:0.9rem; font-weight:700; opacity:0.9; color:rgba(245,230,211,0.9); }
  
  /* small offset so page content sits below header */
  .wrap { max-width:var(--maxw); margin:0 auto; padding:22px; padding-top: 96px; }

  .top{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom:18px; }
  .left-head{ display:flex; gap:12px; align-items:center; }
  .back{ display:inline-flex; gap:8px; align-items:center; text-decoration:none; color:white; background:linear-gradient(90deg,var(--accent),var(--accent-accent)); padding:10px 12px; border-radius:10px; box-shadow: var(--shadow-soft); font-weight:700; }
  .page-title{ font-family:'Playfair Display', serif; font-size:1.5rem; margin:0; color:#3b2b1b; }
  .subtitle{ font-size:.95rem; color:var(--muted); margin-top:4px; }

  .controls{ display:flex; gap:10px; align-items:center; }
  .search-input{ padding:10px 14px; border-radius:999px; border:1px solid rgba(0,0,0,0.06); min-width:240px; background:rgba(255,255,255,0.95); box-shadow: 0 2px 8px rgba(2,6,23,0.04); }
  .sort-select{ padding:9px 10px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); background:white; }

  .grid{ display:grid; grid-template-columns: repeat(auto-fill,minmax(300px,1fr)); gap:18px; margin-top:50px; }

  .card{ position: relative; display:flex; gap:14px; background: linear-gradient(180deg, var(--card-bg), #fff); border-radius: var(--radius) ; padding:16px; align-items:flex-start; box-shadow: var(--shadow-soft); transition: transform .16s ease, box-shadow .16s ease; overflow: visible; border: 2px solid rgba(212,163,115,0.35); }
  .card:hover { transform: translateY(-6px); box-shadow: 0 20px 46px rgba(12,18,30,0.14); }

  .accent-strip{ position:absolute; left:0; top:0; bottom:0; width:6px; border-top-left-radius:var(--radius); border-bottom-left-radius:var(--radius); background: linear-gradient(180deg,var(--accent), #b7791f); }

  .card-left{ width:120px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
  .cover-wrap{ width:104px; height:104px; border-radius:50%; display:grid; place-items:center; background: linear-gradient(135deg,#fff,#fff9f0); box-shadow: 0 8px 20px rgba(12,20,30,0.08); border: 6px solid rgba(255,255,255,0.6); overflow:hidden; }
  .cover-wrap img{ width:100%; height:100%; object-fit:contain; display:block; }

  .card-body{ flex:1; min-width:0; display:flex; flex-direction:column; gap:6px; }
  .card-title{ font-weight:800; font-size:1.02rem; color:#0f172a; margin:0; line-height:1.18; }
  .card-author{ color:var(--muted); font-size:.92rem; display:flex; align-items:center; gap:8px; margin-top:2px; }
  .card-meta{ display:flex; gap:10px; align-items:center; color:var(--muted); font-size:.86rem; margin-top:4px; }

  .chips{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .chip{ font-weight:700; font-size:0.78rem; padding:6px 8px; border-radius:999px; background:linear-gradient(180deg, #fff, #fff8f0); color:#5a3825; border:1px solid rgba(0,0,0,0.03); }

  .actions{ display:flex; gap:8px; margin-top:14px; flex-wrap:wrap; }
  .btn{ display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border:none; border-radius:10px; font-weight:700; cursor:pointer; text-decoration:none; transition: all .2s ease; }
  .btn.read{ background: linear-gradient(90deg,#7c3aed,#4f46e5); color:white; }
  .btn.download{ background: linear-gradient(90deg,#d4a373,#c17c4a); color:white; }
  .btn.fav{ background: linear-gradient(90deg,#ffd166,#ff7b7b); color:white; }

  @media (max-width:640px){
    .grid{ grid-template-columns: repeat(auto-fill,minmax(240px,1fr)); }
    .card{ flex-direction:column; align-items:center; text-align:center; padding:18px; }
    .accent-strip{ display:none; }
    .card-left{ width:unset; }
    .card-body{ align-items:center; }
    .wrap { padding-top:110px; }
  }
</style>
</head>
<body>
  <!-- ---------- HEADER (requested) ---------- -->
  <header>
    <div class="header-left">
      <div class="logo"><i class="fa-solid fa-book"></i><span style="margin-left:6px;">BookVerse</span></div>
      <div id="welcomeName">Welcome</div>
    </div>

    <div class="header-right">
      <div id="dateTime" aria-live="polite" title="Current date and time">
        <span id="dtText">â€”</span>
        <small>IST</small>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="top">
      <div class="left-head">
        <a class="back" href="dashboard.html"><i class="fa-solid fa-arrow-left"></i> Dashboard</a>
        <div>
          <h1 class="page-title">Advanced Topics</h1>
          <div class="subtitle">Explore specialized domains & cutting-edge concepts</div>
        </div>
      </div>

      <div class="controls">
        <input id="q" class="search-input" placeholder="Search title, author or tag..." aria-label="Search books">
        <select id="sort" class="sort-select" aria-label="Sort books">
          <option value="default">Sort: Default</option>
          <option value="year-desc">Year (new â†’ old)</option>
          <option value="year-asc">Year (old â†’ new)</option>
          <option value="title">Title (A â†’ Z)</option>
        </select>
      </div>
    </div>

    <div class="grid" id="grid" role="list"></div>
  </div>

<script type="module">
  /* ---------- Imports ---------- */
  import { auth, db } from "./firebase-config.js";  // same folder as HTML
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { doc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ðŸ”´ Use central favourites API
  import {
    getLocalFavourites,
    addFavourite,
    removeFavourite,
    isFavouriteLocal
  } from "./fav-api.js";

  const dtText = document.getElementById('dtText');
  const welcomeNameEl = document.getElementById('welcomeName');

  /* ---------- Clock (Asia/Kolkata) ---------- */
  function formatKolkata(dt){
    try{
      return new Intl.DateTimeFormat('en-IN', {
        dateStyle: 'medium',
        timeStyle: 'short',
        timeZone: 'Asia/Kolkata'
      }).format(dt);
    } catch(e){
      return dt.toLocaleString();
    }
  }
  function startClock(){
    function tick(){ if(dtText) dtText.textContent = formatKolkata(new Date()); }
    tick();
    setInterval(tick, 1000);
  }
  startClock();

  /* ---------- Welcome name (Firebase profile) ---------- */
  onAuthStateChanged(auth, async (user) => {
    const cached = sessionStorage.getItem('fullname') || null;

    if (!user) {
      welcomeNameEl.textContent = cached ? `Welcome! ${cached}` : 'Welcome';
      return;
    }

    let resolvedName = user.displayName || cached || 'Welcome';
    welcomeNameEl.textContent = `Welcome! ${resolvedName}`;

    try {
      const editRef = doc(db, 'users', user.uid, 'editProfiles', 'profile');
      onSnapshot(
        editRef,
        snap => {
          if (snap.exists() && snap.data().fullname) {
            resolvedName = snap.data().fullname;
          }
          welcomeNameEl.textContent = `Welcome! ${resolvedName}`;
          sessionStorage.setItem('fullname', resolvedName);
          sessionStorage.setItem('fullnameUpdatedAt', Date.now());
        },
        async (err) => {
          console.warn('profile snapshot err', err);
          try {
            const fallback = await getDoc(editRef);
            if (fallback.exists() && fallback.data().fullname) {
              resolvedName = fallback.data().fullname;
            }
          } catch (e){}
          welcomeNameEl.textContent = `Welcome! ${resolvedName}`;
        }
      );
    } catch (e) {
      console.warn('load profile err', e);
      welcomeNameEl.textContent = `Welcome! ${resolvedName}`;
    }
  });

  /* ---------- CS Fundamentals books ---------- */
  const BOOKS = [
{
    id: "cv-AI",
    title: "Artificial Intelligence: A Modern Approach",
    author: "oswald campesato",
    cover: "css/assets/covers/aiml.png",
    href: "css/domains/AIML.pdf",
    type: "pdf",
    year: "2020",
    tags: ["Machine Learning", "Neural Networks", "AI/ML"]
  },
  {
    id: "cv-DS",
    title: "Data Science from Scratch",
    author: "Joel Grus",
    cover: "css/assets/covers/DS.png",
    href: "css/domains/Data Science.pdf",
    type: "pdf",
    year: "2015",
    tags: ["Data Analysis", "Statistics", "Python", "Big Data"]
  }
 ];

  // âœ… Continue-reading offline only (same as before)
  const CKEY = "bookverse_continue";

  function getContinueLocal(){
    try{
      return JSON.parse(localStorage.getItem(CKEY) || "[]");
    } catch(e){
      return [];
    }
  }

  function addContinueLocal(book){
    const arr = getContinueLocal();
    if (!arr.some(b => b.id === book.id)) {
      arr.unshift({ ...book, lastOpened: Date.now() });
      localStorage.setItem(CKEY, JSON.stringify(arr));
      try{ localStorage.setItem('__cont_sync', Date.now().toString()); }catch(e){}
      return true;
    }
    return false;
  }

  function iconFor(type){ return type === "pdf" ? "fa-file-pdf" : "fa-file-lines"; }

  // âœ… Build sets from shared favourites API
  function buildFavSet() {
    return new Set(
      getLocalFavourites().map(b => b.id || b.bookId)
    );
  }

  function buildContinueSet() {
    return new Set(
      getContinueLocal().map(b => b.id)
    );
  }

  /* ---------- Filter + Sort ---------- */
  function applyFilterAndSort(){
    const qEl   = document.getElementById('q');
    const sortEl= document.getElementById('sort');

    const q    = qEl ? qEl.value.trim().toLowerCase() : "";
    const sort = sortEl ? sortEl.value : "default";

    let list = BOOKS.filter(b => {
      if (!q) return true;
      return (
        b.title.toLowerCase().includes(q) ||
        (b.author || '').toLowerCase().includes(q) ||
        (b.tags || []).join(' ').toLowerCase().includes(q)
      );
    });

    if (sort === "year-desc") list = list.slice().sort((a,b)=> (b.year||0)-(a.year||0));
    if (sort === "year-asc")  list = list.slice().sort((a,b)=> (a.year||0)-(b.year||0));
    if (sort === "title")     list = list.slice().sort((a,b)=> a.title.localeCompare(b.title));

    return list;
  }

  /* ---------- Render grid ---------- */
  function renderGrid(list = BOOKS){
    const grid = document.getElementById('grid');
    if (!grid) return;

    const favSet  = buildFavSet();
    const contSet = buildContinueSet();

    grid.innerHTML = '';

    list.forEach(b => {
      const card = document.createElement('article');
      card.className = 'card';
      card.setAttribute('role','listitem');

      const stripe = document.createElement('div');
      stripe.className = 'accent-strip';
      card.appendChild(stripe);

      const left = document.createElement('div');
      left.className = 'card-left';
      const coverWrap = document.createElement('div');
      coverWrap.className = 'cover-wrap';
      const img = document.createElement('img');
      img.alt = b.title;
      img.src = b.cover;
      img.onerror = () => img.src = 'https://via.placeholder.com/120x120?text=Book';
      coverWrap.appendChild(img);
      left.appendChild(coverWrap);

      const body = document.createElement('div');
      body.className = 'card-body';

      const title = document.createElement('div');
      title.className = 'card-title';
      title.textContent = b.title;

      const author = document.createElement('div');
      author.className = 'card-author';
      author.innerHTML = `<i class="fa-solid fa-user"></i> ${b.author}`;

      const meta = document.createElement('div');
      meta.className = 'card-meta';
      meta.innerHTML = `<i class="fa-solid ${iconFor(b.type)}"></i> â€¢ ${b.type.toUpperCase()} â€¢ <i class="fa-regular fa-calendar"></i> ${b.year}`;

      const chips = document.createElement('div');
      chips.className = 'chips';
      (b.tags || []).forEach(t => {
        const c = document.createElement('div');
        c.className = 'chip';
        c.textContent = t;
        chips.appendChild(c);
      });

      const actions = document.createElement('div');
      actions.className = 'actions';

      const read = document.createElement('a');
      read.className = 'btn read';
      read.href = b.href;
      read.target = '_blank';
      read.rel = 'noopener';
      read.innerHTML = `<i class="fa-solid fa-book-open"></i> Read`;

      const download = document.createElement('a');
      download.className = 'btn download';
      download.href = b.href;
      download.download = '';
      download.innerHTML = `<i class="fa-solid fa-download"></i> Download`;

      const favBtn = document.createElement('button');
      favBtn.className = 'btn fav';
      favBtn.type = 'button';

      const isFav = favSet.has(b.id) || isFavouriteLocal(b.id);
      favBtn.innerHTML = isFav
        ? '<i class="fa-solid fa-heart" style="color:#e11d48;"></i> Remove Fav'
        : '<i class="fa-solid fa-heart" style="color:#e11d48;"></i> Add to Fav';

      // â¤ï¸ FAV CLICK â†’ central API + lastFavSeed
      favBtn.addEventListener('click', async (ev) => {
        ev.preventDefault();

        const currentlyFav = isFavouriteLocal(b.id);

        if (currentlyFav) {
          // remove from local + Firestore
          await removeFavourite(b.id);
        } else {
          // seed object for recs
          const seedBook = {
            ...b,
            domain: "Computer Science",
            category: "CS Fundamentals"
          };

          // ðŸ‘‰ dashboard ki hint for instant rec
          try {
            sessionStorage.setItem('lastFavSeed', JSON.stringify(seedBook));
          } catch (e) {
            console.warn('[cs-fund] lastFavSeed sessionStorage error', e);
          }

          // add to local + Firestore
          await addFavourite(seedBook);
        }

        // re-render with fresh local favourites
        renderGrid(applyFilterAndSort());
      });

      // ðŸ“– READ â†’ continue-reading API
      read.addEventListener('click', async (ev) => {
        ev.preventDefault();
        window.open(b.href, '_blank', 'noopener');

        // Try cloud continue-api; fallback to local
        try {
          const mod = await import('./continue-api.js');
          await mod.addContinue(b);
        } catch(e){
          addContinueLocal(b);
        }

        renderGrid(applyFilterAndSort());
      });

      actions.appendChild(read);
      actions.appendChild(download);
      actions.appendChild(favBtn);

      body.appendChild(title);
      body.appendChild(author);
      body.appendChild(meta);
      body.appendChild(chips);
      body.appendChild(actions);

      card.appendChild(left);
      card.appendChild(body);
      grid.appendChild(card);
    });
  }

  /* ---------- Search + Sort listeners ---------- */
  document.getElementById('q').addEventListener('input', () => {
    renderGrid(applyFilterAndSort());
  });

  document.getElementById('sort').addEventListener('change', () => {
    renderGrid(applyFilterAndSort());
  });

  /* ---------- Initial render ---------- */
  renderGrid(BOOKS);
</script>

<script src="domain-hash-filter.js"></script>
</body>
</html>
