<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign Up | BookVerse</title>
  <link rel="stylesheet" href="css/signup.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

</head>
<body class="login-page">
  <div class="login-container">

    <!-- Left side with image and quote -->
    <div class="login-image">
      <img src="css/assets/images/login image.jpeg" alt="Books">
      <div class="login-quote">
        <p>‚ÄúA library is not a luxury but one of the necessities of life.‚Äù</p>
      </div>
    </div>

    <!-- Right side signup form -->
    <div class="login-form">
      <div class="login-form">
  <!-- üîô Back to landing page -->
  <div class="back-home">
    <a href="index.html">
      <i class="fa-solid fa-arrow-left"></i>
      Back to BookVerse
    </a>
  </div>
  
      <h2>Create Account</h2>
      <p>Sign up to start your BookVerse journey</p>

      <form id="signupForm">

        <div class="input-group">
          <label for="fullname">Full Name</label>
          <input type="text" id="fullname" placeholder="Enter your full name" required>
          <small class="error" id="fullnameError"></small>
        </div>

        <div class="input-group">
          <label for="email">Email</label>
          <input type="email" id="email" placeholder="Enter your email" required>
          <small class="error" id="emailError"></small>
        </div>

        <div class="input-group">
          <label for="phone">Phone Number</label>
          <input type="tel" id="phone" placeholder="Enter your phone number" required>
          <small class="error" id="phoneError"></small>
        </div>

      <div class="input-group">
      <label for="password">Password</label>
      <input type="password" id="password" placeholder="Enter your password" required>
      <i class="fa-solid fa-eye-slash password-toggle" id="togglePassword"></i>
      <small class="error" id="passwordError"></small>
    </div>

    <div class="input-group">
      <label for="repassword">Retype Password</label>
      <input type="password" id="repassword" placeholder="Retype your password" required>
      <i class="fa-solid fa-eye-slash password-toggle" id="toggleRePassword"></i>
      <small class="error" id="repasswordError"></small>
    </div>

        <!-- Error message placeholder -->
<p id="error-message" style="color: red; font-size: 14px; margin-top: 8px;"></p>

        <button type="submit" class="btn" id="registerBtn">Register</button>
        <p class="success-message" id="successMessage">‚úÖ Registration successful!</p>
      </form>

      <div class="or-divider">or</div>

<!-- Google Sign Up Button -->
<button type="button" class="google-btn">
  <img src="css/assets/icons/google.jpeg" alt="Google Icon"> Continue with Google
</button>

      <div class="signup-link">
        <p>Already have an account? <a href="login.html">Sign In</a></p>
      </div>
    </div>

  </div>

  <!-- JavaScript for real-time validation -->
<script type="module">
import { auth, db } from "./firebase-config.js";
import {
  createUserWithEmailAndPassword,
  updateProfile        // ‚úÖ NEW: to set displayName
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Form elements
const form = document.getElementById("signupForm");
const successMessage = document.getElementById("successMessage");
const registerBtn = document.getElementById("registerBtn");
const errorMessageEl = document.getElementById("error-message");

const fullname = document.getElementById("fullname");
const email = document.getElementById("email");
const phone = document.getElementById("phone");
const password = document.getElementById("password");
const repassword = document.getElementById("repassword");

const fullnameError = document.getElementById("fullnameError");
const emailError = document.getElementById("emailError");
const phoneError = document.getElementById("phoneError");
const passwordError = document.getElementById("passwordError");
const repasswordError = document.getElementById("repasswordError");

// --- Validation function ---
function validateField(input, regex, errorElement, message) {
  if (!regex.test(input.value.trim())) {
    errorElement.textContent = message;
    input.classList.add("error-input");
    return false;
  } else {
    errorElement.textContent = "";
    input.classList.remove("error-input");
    return true;
  }
}

// --- Real-time validation ---
fullname.addEventListener("input", () =>
  validateField(fullname, /^[A-Za-z ]+$/, fullnameError, "Only letters are allowed.")
);

email.addEventListener("input", () =>
  validateField(email, /^[^ ]+@[^ ]+\.[a-z]{2,3}$/, emailError, "Enter a valid email address.")
);

phone.addEventListener("input", () =>
  validateField(phone, /^[0-9]{10}$/, phoneError, "Phone number must be 10 digits.")
);

password.addEventListener("input", () =>
  validateField(password, /^.{6,}$/, passwordError, "Password must be at least 6 characters.")
);

repassword.addEventListener("input", () => {
  if (repassword.value !== password.value) {
    repasswordError.textContent = "Passwords do not match.";
    repassword.classList.add("error-input");
  } else {
    repasswordError.textContent = "";
    repassword.classList.remove("error-input");
  }
});

// --- Toggle password visibility ---
document.getElementById("togglePassword").addEventListener("click", () => {
  const type = password.type === "password" ? "text" : "password";
  password.type = type;
  document.getElementById("togglePassword").classList.toggle("fa-eye");
  document.getElementById("togglePassword").classList.toggle("fa-eye-slash");
});

document.getElementById("toggleRePassword").addEventListener("click", () => {
  const type = repassword.type === "password" ? "text" : "password";
  repassword.type = type;
  document.getElementById("toggleRePassword").classList.toggle("fa-eye");
  document.getElementById("toggleRePassword").classList.toggle("fa-eye-slash");
});

// --- Form submit ---
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  errorMessageEl.textContent = "";

  const isFullnameValid = validateField(fullname, /^[A-Za-z ]+$/, fullnameError, "Only letters are allowed.");
  const isEmailValid = validateField(email, /^[^ ]+@[^ ]+\.[a-z]{2,3}$/, emailError, "Enter a valid email address.");
  const isPhoneValid = validateField(phone, /^[0-9]{10}$/, phoneError, "Phone number must be 10 digits.");
  const isPasswordValid = validateField(password, /^.{6,}$/, passwordError, "Password must be at least 6 characters.");
  const isRepasswordValid = repassword.value === password.value;

  if (!isRepasswordValid) {
    repasswordError.textContent = "Passwords do not match.";
    repassword.classList.add("error-input");
  }

  if (isFullnameValid && isEmailValid && isPhoneValid && isPasswordValid && isRepasswordValid) {
    try {
      registerBtn.disabled = true;
      registerBtn.textContent = "Registering...";

      const fullNameValue = fullname.value.trim();
      const emailValue    = email.value.trim();
      const phoneValue    = phone.value.trim();

      // 1Ô∏è‚É£ Create user (Auth)
      const userCredential = await createUserWithEmailAndPassword(
        auth,
        emailValue,
        password.value.trim()
      );
      const user = userCredential.user;

      // 2Ô∏è‚É£ Set Firebase Auth displayName (so dashboard user.displayName works)
      await updateProfile(user, {
        displayName: fullNameValue
      });

      // 3Ô∏è‚É£ Top-level user doc (your existing one)
      await setDoc(doc(db, "users", user.uid), {
        fullname: fullNameValue,
        email: emailValue,
        phone: phoneValue,
        createdAt: new Date()
      });

      // 4Ô∏è‚É£ üî• NEW: Create profile subdoc used by dashboard listener
      await setDoc(doc(db, "users", user.uid, "editProfiles", "profile"), {
        fullname: fullNameValue,
        email: emailValue,
        phone: phoneValue,
        createdAt: new Date()
      }, { merge: true });

      // 5Ô∏è‚É£ (Optional) cache name in this browser session
      sessionStorage.setItem("fullname", fullNameValue);

      successMessage.classList.add("show");
      registerBtn.textContent = "‚úî Registered";

      // You can redirect either to login.html or dashboard.html
      setTimeout(() => {
        window.location.href = "login.html";
      }, 2000);

    } catch (error) {
      if (error.code === "auth/email-already-in-use") {
        errorMessageEl.textContent = "This email is already in use.";
      } else if (error.code === "auth/weak-password") {
        errorMessageEl.textContent = "Password should be at least 6 characters.";
      } else {
        errorMessageEl.textContent = "Error: " + error.message;
      }
      registerBtn.disabled = false;
      registerBtn.textContent = "Register";
    }
  }
});

// ‚≠ê Google Sign Up (same as Sign In)
import { provider } from "./firebase-config.js";
import { signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

document.querySelector(".google-btn").addEventListener("click", async () => {
  try {
    const result = await signInWithPopup(auth, provider);
    const user = result.user;

    // Save user details in Firestore (top-level)
    await setDoc(doc(db, "users", user.uid), {
      fullname: user.displayName,
      email: user.email,
      phone: user.phoneNumber || "",
      createdAt: new Date(),
      provider: "google"
    }, { merge: true });

    // üî• NEW: also create editProfiles/profile doc for consistency
    await setDoc(doc(db, "users", user.uid, "editProfiles", "profile"), {
      fullname: user.displayName,
      email: user.email,
      phone: user.phoneNumber || "",
      createdAt: new Date()
    }, { merge: true });

    // cache name + popup flag
    sessionStorage.setItem("fullname", user.displayName || "");
    sessionStorage.setItem("showWelcomePopup", "1");

    window.location.href = "dashboard.html";
  } catch (error) {
    console.error("Google Sign Up Error:", error);
    errorMessageEl.textContent = "Google sign-up failed. Try again.";
  }
});
</script>

</body>
</html>