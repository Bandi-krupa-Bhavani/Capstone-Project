<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Continue Reading | BookVerse</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@500;700&display=swap" rel="stylesheet">

  <style>
    /* (Your styles unchanged) */
    body { margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background: linear-gradient(rgba(240,207,177,0.7), rgba(239,207,177,0.8)), url("css/assets/images/dashboard-image.avif"); background-size:cover; background-position:center; background-attachment: fixed; color:#0f172a; }
  
     /* ---------- Header (profile-style) ---------- */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 0 20px;
      background: rgba(62,44,32,0.95);
      color: #F5E6D3;
      z-index: 1000;
      box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    }

     /* left and right groups */
    .header-left, .header-right { display:flex; align-items:center; gap:12px; }
    .logo { display:flex; align-items:center; gap:8px; font-weight:700; font-size:20px; color:#F5E6D3; }
    .logo i { font-size:20px; }
    #welcomeName { font-weight:600; color:#F5E6D3; margin-left:15px; font-size:0.98rem; }
    #dateTime { font-size:0.9rem; color: rgba(245,230,211,0.95); padding:6px 10px; background: rgba(0,0,0,0.08); border-radius:8px; display:flex; align-items:center; gap:8px; }
    #dateTime small { font-size:0.9rem; font-weight:800;opacity:0.9; color:rgba(245,230,211,0.9); }

    .top-bar{ display:flex; align-items:center; gap:15px; padding:90px 40px 20px 40px; transition:margin-left .3s ease; }
    .top-bar.shift{ margin-left:270px; }
    .library-title h2{ margin:-10px 60px; color:rgba(62,44,32,0.95); }
    .library-title p{ margin:20px 60px 0; color:#5a3d2b; font-size:14px; }
    .sidebar{ position:fixed; top:60px; left:-250px; width:250px; height:100%; background:transparent; padding-top:60px; transition:left .3s ease; }
    .sidebar.active{ left:0; }
    .sidebar a{ display:block; padding:15px 20px; color:rgba(62,44,32,0.95); text-decoration:none; }
    .sidebar a:hover{ background:rgba(255,255,255,0.2); }
    .toggle-btn{ position:fixed; top:70px; left:15px; font-size:25px; background:rgba(62,44,32,0.95); color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; z-index:1000; }
    .content{ margin-left:0; transition:margin-left .3s ease; padding:20px 40px; }
    .content.shift{ margin-left:270px; }
    #contList{ display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:18px; margin-top:30px; padding:24px; min-height:220px; position:relative; }
    #contList .card{ position:relative; display:flex; gap:14px; background: linear-gradient(180deg, rgba(255,255,255,0.98), #fff); border-radius:14px; padding:16px; align-items:flex-start; box-shadow:0 8px 30px rgba(12,18,30,0.06); transition:transform .16s ease, box-shadow .16s ease; border:1px solid rgba(14,20,30,0.03); overflow:visible; }
    #contList .card:hover{ transform:translateY(-6px); box-shadow:0 20px 46px rgba(12,18,30,0.14); }
    #contList .accent-strip{ position:absolute; left:0; top:0; bottom:0; width:6px; border-top-left-radius:14px; border-bottom-left-radius:14px; background: linear-gradient(180deg,#d4a373,#c17c4a); }
    #contList .card-left{ width:120px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
    #contList .cover-wrap{ width:104px; height:104px; border-radius:50%; display:grid; place-items:center; background: linear-gradient(135deg,#fff,#fff9f0); box-shadow:0 8px 20px rgba(12,20,30,0.08); border:6px solid rgba(255,255,255,0.6); overflow:hidden; }
    #contList .cover-wrap img{ width:100%; height:100%; object-fit:contain; display:block; }
    #contList .card-body{ flex:1; min-width:0; display:flex; flex-direction:column; gap:6px; }
    #contList .card-title{ font-weight:800; font-size:1.02rem; color:#0f172a; margin:0; line-height:1.18; }
    #contList .card-author{ color:#6b7280; font-size:.92rem; display:flex; align-items:center; gap:8px; margin-top:2px; }
    #contList .card-meta{ display:flex; gap:10px; align-items:center; color:#6b7280; font-size:.86rem; margin-top:4px; }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .chip{ font-weight:700; font-size:0.78rem; padding:6px 8px; border-radius:999px; background:linear-gradient(180deg,#fff,#fff8f0); color:#5a3825; border:1px solid rgba(0,0,0,0.03); }
    .actions{ display:flex; gap:8px; margin-top:14px; flex-wrap:wrap; }
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border:none; border-radius:10px; font-weight:700; cursor:pointer; text-decoration:none; transition: all .2s ease; }
    .btn.read{ background: linear-gradient(90deg,#7c3aed,#4f46e5); color:white; }
    .btn.download{ background: linear-gradient(90deg,#d4a373,#c17c4a); color:white; }
    .btn.remove{ background: linear-gradient(90deg,#ffd166,#ff7b7b); color:white; }
    @media (max-width:720px){ #contList{ grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:14px; padding:12px; } #contList .card{ flex-direction:column; align-items:center; text-align:center; } #contList .accent-strip{ display:none; } #contList .card-left{ width:auto; } }
    .empty-msg{ position:absolute; top:50%; left:50%; transform: translate(-50%,-50%); width:80%; max-width:820px; background: linear-gradient(90deg, rgba(255,255,255,0.9), rgba(255,247,237,0.95)); border:2px solid rgba(212,163,115,0.35); border-radius:16px; padding:28px 32px; box-shadow:0 6px 24px rgba(0,0,0,0.08); text-align:center; font-family:'Playfair Display', serif; font-size:1.15rem; font-weight:600; color:#5a3d2b; line-height:1.4; letter-spacing:0.3px; opacity:0.98; backdrop-filter: blur(6px) saturate(120%); display:flex; align-items:center; justify-content:center; gap:14px; }
    .empty-cta{ padding:8px 12px; border-radius:10px; border:none; background:linear-gradient(90deg,#7c3aed,#4f46e5); color:white; font-weight:700; cursor:pointer; }
  </style>
</head>
<body>
  <!-- Header (profile-style) -->
  <header>
    <div class="header-left">
      <div class="logo"><i class="fa-solid fa-book"></i><span style="margin-left:6px;">BookVerse</span></div>
      <div id="welcomeName">Welcome</div>
    </div>

    <div class="header-right">
      <div id="dateTime" aria-live="polite" title="Current date and time">
        <span id="dtText">—</span>
        <small>IST</small>
      </div>
    </div>
  </header>

  <div class="top-bar" id="topBar">
    <button class="toggle-btn" id="toggleBtn">☰</button>
    <div class="library-title">
      <h2>⏱ Continue Reading</h2>
      <p>Your in-progress books — resume where you left off.</p>
    </div>
  </div>

  <div class="sidebar" id="sidebar">
    <a href="dashboard.html"><i class="fa-solid fa-house"></i> Dashboard</a>
    <a href="library.html"><i class="fa-solid fa-book-open"></i> My Library</a>
    <a href="continue-read.html" class="active"><i class="fa-solid fa-clock"></i> Continue Reading</a>
    <a href="fav.html"><i class="fa-solid fa-heart"></i> My Favourites</a>
    <a href="profile.html"><i class="fa-solid fa-user"></i> Profile</a>
    <a href="home.html"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
  </div>

  <div class="content" id="mainContent">
    <div id="contList" aria-live="polite"></div>
  </div>

  <script type="module">
  import { auth, db } from "./firebase-config.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { doc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const CKEY = 'bookverse_continue';
  const contListEl = document.getElementById('contList');

  function getContinueLocal(){ return JSON.parse(localStorage.getItem(CKEY) || '[]'); }
  function setContinueLocal(arr){ localStorage.setItem(CKEY, JSON.stringify(arr)); }
  function removeContinueLocal(id){ const arr = getContinueLocal().filter(x=>x.id!==id); setContinueLocal(arr); renderLocalContinue(); }

  function renderLocalContinue(){
    const arr = getContinueLocal();
    contListEl.innerHTML = '';
    if(!arr.length){
      contListEl.innerHTML = `
        <div class="empty-msg" role="status">
          <i class="fa-solid fa-clock" style="color:#c17c4a; font-size:1.6rem;"></i>
          <div>No books in your continue list — open a book from the dashboard to add it here.</div>
        </div>`;
      return;
    }

    arr.forEach(b => {
      const card = buildCard(b, (id)=> removeContinueLocal(id));
      contListEl.appendChild(card);
    });
  }

  function buildCard(b, removeHandler){
    const card = document.createElement('article'); card.className='card'; card.setAttribute('role','listitem');
    const stripe = document.createElement('div'); stripe.className='accent-strip'; card.appendChild(stripe);

    const left = document.createElement('div'); left.className='card-left';
    const coverWrap = document.createElement('div'); coverWrap.className='cover-wrap';
    const img = document.createElement('img'); img.alt = b.title || 'Book'; img.src = b.cover || 'https://via.placeholder.com/120x120?text=Book';
    img.onerror = ()=> img.src = 'https://via.placeholder.com/120x120?text=Book';
    coverWrap.appendChild(img); left.appendChild(coverWrap);

    const body = document.createElement('div'); body.className='card-body';
    const title = document.createElement('div'); title.className='card-title'; title.textContent = b.title || 'Untitled';
    const author = document.createElement('div'); author.className='card-author'; author.innerHTML = `<i class="fa-solid fa-user"></i> ${b.author || 'Unknown'}`;
    const meta = document.createElement('div'); meta.className='card-meta'; meta.innerHTML = `<i class="fa-solid fa-file-pdf"></i> ${(b.type||'PDF').toUpperCase()} • <i class="fa-regular fa-calendar"></i> ${b.year || ''}`;

    const chips = document.createElement('div'); chips.className='chips';
    (b.tags || []).slice(0,3).forEach(t => { const c = document.createElement('div'); c.className = 'chip'; c.textContent = t; chips.appendChild(c); });

    const actions = document.createElement('div'); actions.className='actions';
    const read = document.createElement('a'); read.className='btn read'; read.href = b.href || '#'; read.target = '_blank'; read.rel='noopener'; read.innerHTML = `<i class="fa-solid fa-book-open"></i> Resume`;
    const download = document.createElement('a'); download.className='btn download'; download.href = b.href || '#'; download.download = ''; download.innerHTML = `<i class="fa-solid fa-download"></i> Download`;
    const rem = document.createElement('button'); rem.className='btn remove'; rem.type='button'; rem.innerHTML = `<i class="fa-solid fa-trash"></i> Remove`;

    read.addEventListener('click', (ev)=>{
      try {
        const arr = getContinueLocal();
        const idx = arr.findIndex(x=>x.id===b.id);
        const now = Date.now();
        if(idx >= 0){ arr[idx].lastOpened = now; const item = arr.splice(idx,1)[0]; arr.unshift(item); setContinueLocal(arr); }
        else { arr.unshift({...b, lastOpened: now}); setContinueLocal(arr); }
        tryUpdateRemoteContinue(b.id, {...b, lastOpened: now});
      } catch(e){}
    });

    rem.addEventListener('click', ()=>{
      if(typeof removeHandler === 'function') removeHandler(b.id);
      tryDeleteRemoteContinue(b.id);
    });

    actions.appendChild(read); actions.appendChild(download); actions.appendChild(rem);

    body.appendChild(title); body.appendChild(author); body.appendChild(meta); body.appendChild(chips); body.appendChild(actions);
    card.appendChild(left); card.appendChild(body);
    return card;
  }

  // ---------- Firestore integration (patched) ----------
  (async function initFirestore(){
    try {
      const fb = await import('./firebase-config.js'); // ensure this path is correct
      const authMod = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js');
      const fsMod = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');

      const { auth, db } = fb;
      const { onAuthStateChanged } = authMod;
      const { collection, query, onSnapshot, doc, setDoc, deleteDoc, orderBy } = fsMod;

      let unsub = null; let currentUid = null;
      const contCollectionRef = (uid) => collection(db, 'users', uid, 'continueReading');
      const contDocRef = (uid, id) => doc(db, 'users', uid, 'continueReading', id);

      async function migrateLocalToRemote(user){
        try {
          const local = getContinueLocal();
          if(!Array.isArray(local) || local.length === 0) return;
          for(const b0 of local){
            if(!b0) continue;
            const id = b0.id || (typeof crypto !== 'undefined' ? crypto.randomUUID() : 'id_'+Date.now());
            const b = { ...b0, id };
            try {
              await setDoc(contDocRef(user.uid, id), b, { merge: true });
              console.log('[migrate] wrote', id);
            } catch(e){
              console.warn('[migrate] single err', e);
            }
          }
        } catch(e){ console.warn('migrate cont err', e); }
      }

      function subscribe(uid){
        if(unsub){ try{ unsub(); }catch(e){} unsub = null; }
        const q = query(contCollectionRef(uid), orderBy('lastOpened','desc'));
        unsub = onSnapshot(q, snap => {
          const arr = snap.docs.map(d=>d.data()).sort((a,b)=> (b.lastOpened||0)-(a.lastOpened||0));
          try{ setContinueLocal(arr); } catch(e){ console.warn('mirror to local failed', e); }
          contListEl.innerHTML = '';
          if(!arr.length){
            contListEl.innerHTML = `<div class="empty-msg" role="status"><i class="fa-solid fa-clock" style="color:#c17c4a; font-size:1.6rem;"></i><div>No books in your continue list — open a book from the dashboard to add it here.</div></div>`;
            return;
          }
          arr.forEach(docObj => {
            const card = buildCard(docObj, async (id)=> {
              try { await deleteDoc(contDocRef(uid,id)); console.log('[remote] deleted', id); } catch(e){ console.error('remove cont remote', e); }
            });
            contListEl.appendChild(card);
          });
        }, err => { console.error('cont snapshot err', err); renderLocalContinue(); });
      }

      onAuthStateChanged(auth, async (user)=>{
        try {
          console.log('onAuthStateChanged ->', user ? user.uid : null);
          if(user){ currentUid = user.uid; await migrateLocalToRemote(user).catch((e)=>console.warn('migrate err', e)); subscribe(currentUid); }
          else { currentUid = null; if(unsub){ unsub(); unsub = null; } renderLocalContinue(); }
        } catch(e){ console.error('auth handler err', e); }
      });

      window.tryUpdateRemoteContinue = async (id, payload) => {
        try { if(!currentUid) return; await setDoc(contDocRef(currentUid, id), payload, { merge: true }); console.log('[remote] setDoc', id); } catch(e){ console.error('[remote] setDoc err', e); }
      };

      window.tryDeleteRemoteContinue = async (id) => {
        try { if(!currentUid) return; await deleteDoc(contDocRef(currentUid, id)); console.log('[remote] deleteDoc', id); } catch(e){ console.error('[remote] deleteDoc err', e); }
      };

      renderLocalContinue();

    } catch(err){ console.warn('Firestore unavailable for continue-read, using local fallback', err); renderLocalContinue(); }
  })();

  // Sidebar toggle behaviour
    const welcomeNameEl = document.getElementById('welcomeName'); // <div id="welcomeName">
  const dtText = document.getElementById('dtText'); 
  document.addEventListener('DOMContentLoaded', ()=>{
    const toggleBtn = document.getElementById('toggleBtn');
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const topBar = document.getElementById('topBar');

    if(toggleBtn){ toggleBtn.addEventListener('click', ()=>{ sidebar.classList.toggle('active'); mainContent.classList.toggle('shift'); topBar.classList.toggle('shift'); }); }
  });
  
  // --- Clock: write only into the dtText span so the small "IST" remains ---
  function formatKolkata(dt) {
    try {
      // human-friendly medium date + short time (Asia/Kolkata)
      return new Intl.DateTimeFormat('en-IN', {
        dateStyle: 'medium',
        timeStyle: 'short',
        timeZone: 'Asia/Kolkata'
      }).format(dt);
    } catch (e) {
      return dt.toLocaleString();
    }
  }
  function startClock() {
    function tick() {
      if (dtText) dtText.textContent = formatKolkata(new Date());
    }
    tick();
    setInterval(tick, 1000);
  }
  startClock();

  // --- Welcome name from Firestore (subcollection) with session fallback ---
  onAuthStateChanged(auth, async (user) => {
    // default fallback from sessionStorage (if any)
    const cached = sessionStorage.getItem('fullname') || null;
    if (!user) {
      welcomeNameEl.textContent = cached ? `Welcome! ${cached}` : 'Welcome';
      return;
    }

    // optimistic display
    let resolvedName = user.displayName || cached || 'Welcome';
    welcomeNameEl.textContent = `Welcome! ${resolvedName}`;

    // subscribe to subcollection doc: users/{uid}/editProfiles/profile
    try {
      const editRef = doc(db, 'users', user.uid, 'editProfiles', 'profile');
      onSnapshot(editRef, snap => {
        if (snap.exists() && snap.data().fullname) {
          resolvedName = snap.data().fullname;
        }
        welcomeNameEl.textContent = `Welcome! ${resolvedName}`;
        // cache small
        sessionStorage.setItem('fullname', resolvedName);
        sessionStorage.setItem('fullnameUpdatedAt', Date.now());
      }, async (err) => {
        console.warn('profile snapshot err', err);
        // fallback to a single get if snapshot fails
        try {
          const fallback = await getDoc(editRef);
          if (fallback.exists() && fallback.data().fullname) {
            resolvedName = fallback.data().fullname;
          }
        } catch (e) { /* ignore */ }
        welcomeNameEl.textContent = `Welcome, ${resolvedName}`;
      });
    } catch (e) {
      console.warn('load profile err', e);
      welcomeNameEl.textContent = `Welcome, ${resolvedName}`;
    }
  });

  // keep storage sync for local fallback
  window.addEventListener('storage', (e)=>{ if(e.key === CKEY || e.key === '__cont_sync'){ try { renderLocalContinue(); } catch(e){} } });

  // final: initial render
  renderLocalContinue();
  </script>
</body>
</html>
