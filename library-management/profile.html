<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="css/profile.css">
  <title>Profile Page</title>
</head>
<body>
  <header>
    <div class="header-left">
      <div class="logo"><i class="fa-solid fa-book"></i><span style="margin-left:6px;">BookVerse</span></div>
      <div id="welcomeName">Welcome</div>
    </div>

    <div class="header-right">
      <div id="dateTime" aria-live="polite" title="Current date and time">
        <span id="dtText">‚Äî</span>
        <small>IST</small>
      </div>
    </div>
  </header>

  <div class="sidebar" id="sidebar">
    <a href="dashboard.html"><i class="fa-solid fa-house"></i> Dashboard</a>
    <a href="library.html"><i class="fa-solid fa-book-open"></i> My Library</a>
    <a href="profile.html"><i class="fa-solid fa-user"></i> Profile</a>
    <a href="index.html"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
  </div>

  <button class="toggle-btn" id="toggleBtn">‚ò∞</button>

  <div class="content" id="mainContent">
    <div class="profile-photo-wrapper">
      <div id="profilePhotoContainer"><div class="avatar">U</div></div>
    </div>

    <h2 class="profile-name" id="profileName"></h2><br>
    <div class="actions">
      <a href="edit-profile.html"><button class="action-btn"><span>‚úèÔ∏è</span> Edit Profile</button></a>
      <a href="passw-sec.html"><button class="action-btn"><span>üîí</span> Password & Security</button></a>
      <a href="help-support.html"><button class="action-btn"><span>‚ùì</span> Help & Support</button></a>
      <button class="action-btn" id="logoutBtn"><span>üö™</span> Logout</button>
    </div>
  </div>

<script type="module">
import { auth, db } from "./firebase-config.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { doc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  
const welcomeNameEl = document.getElementById('welcomeName'); // <div id="welcomeName">
const dtText = document.getElementById('dtText'); 
 
const profileName = document.getElementById("profileName");
const profilePhotoContainer = document.getElementById("profilePhotoContainer");

function displayNameAvatar(fullname = "User") {
  profileName.textContent = fullname;
  const letter = fullname.charAt(0).toUpperCase();
  profilePhotoContainer.innerHTML = `<div class="avatar">${letter}</div>`;
}

// --- Display cached name immediately ---
const cachedName = sessionStorage.getItem("fullname");
if (cachedName) {
  displayNameAvatar(cachedName);
}

onAuthStateChanged(auth, (user) => {
  if (!user) {
    sessionStorage.clear();
    window.location.href = "login.html";
    return;
  }

  const editRef = doc(db, "editProfiles", user.uid);

  onSnapshot(editRef, (docSnap) => {
    let fullname = "User";
    if (docSnap.exists() && docSnap.data().fullname?.trim()) {
      fullname = docSnap.data().fullname.trim();
    } else if (user.displayName) {
      fullname = user.displayName;
    }

    // Update sessionStorage with timestamp
    sessionStorage.setItem("fullname", fullname);
    sessionStorage.setItem("fullnameUpdatedAt", Date.now());

    // Update UI only if changed
    if (profileName.textContent !== fullname) {
      displayNameAvatar(fullname);
    }
  });
});

// Logout
document.getElementById("logoutBtn").addEventListener("click", async () => {
  await auth.signOut();
  sessionStorage.clear();
  window.location.href = "index.html";
});

// Sidebar toggle
const toggleBtn = document.getElementById("toggleBtn");
const sidebar = document.getElementById("sidebar");
const mainContent = document.getElementById("mainContent");
toggleBtn.addEventListener("click", () => {
  sidebar.classList.toggle("active");
  mainContent.classList.toggle("shift");
});

// --- Clock: write only into the dtText span so the small "IST" remains ---
  function formatKolkata(dt) {
    try {
      // human-friendly medium date + short time (Asia/Kolkata)
      return new Intl.DateTimeFormat('en-IN', {
        dateStyle: 'medium',
        timeStyle: 'short',
        timeZone: 'Asia/Kolkata'
      }).format(dt);
    } catch (e) {
      return dt.toLocaleString();
    }
  }
  function startClock() {
    function tick() {
      if (dtText) dtText.textContent = formatKolkata(new Date());
    }
    tick();
    setInterval(tick, 1000);
  }
  startClock();

  // --- Welcome name from Firestore (subcollection) with session fallback ---
  onAuthStateChanged(auth, async (user) => {
    // default fallback from sessionStorage (if any)
    const cached = sessionStorage.getItem('fullname') || null;
    if (!user) {
      welcomeNameEl.textContent = cached ? `Welcome! ${cached}` : 'Welcome';
      return;
    }

    // optimistic display
    let resolvedName = user.displayName || cached || 'Welcome';
    welcomeNameEl.textContent = `Welcome! ${resolvedName}`;

    // subscribe to subcollection doc: users/{uid}/editProfiles/profile
    try {
      const editRef = doc(db, 'users', user.uid, 'editProfiles', 'profile');
      onSnapshot(editRef, snap => {
        if (snap.exists() && snap.data().fullname) {
          resolvedName = snap.data().fullname;
        }
        welcomeNameEl.textContent = `Welcome! ${resolvedName}`;
        // cache small
        sessionStorage.setItem('fullname', resolvedName);
        sessionStorage.setItem('fullnameUpdatedAt', Date.now());
      }, async (err) => {
        console.warn('profile snapshot err', err);
        // fallback to a single get if snapshot fails
        try {
          const fallback = await getDoc(editRef);
          if (fallback.exists() && fallback.data().fullname) {
            resolvedName = fallback.data().fullname;
          }
        } catch (e) { /* ignore */ }
        welcomeNameEl.textContent = `Welcome, ${resolvedName}`;
      });
    } catch (e) {
      console.warn('load profile err', e);
      welcomeNameEl.textContent = `Welcome, ${resolvedName}`;
    }
  });


</script>
</body>
</html>
